<script src="../../node_modules/jquery/dist/jquery.min.js"></script>

<script src="../widgets/autoSearchText.js"></script>
<link rel="stylesheet" href="../assets/themes/autoSearchText.css" />
<link rel="stylesheet" href="../assets/themes/purchase_order.css" />
<script src="../accounts/Product.js"></script>
<script src="../accounts/Receipt.js"></script>
<title>PURCHASE ORDER</title>
<body>
  <form id="main-form">
    <div class="client">
      <table class="top-table">
        <div class="container1">
          <div class="material-textfield">
            <input type="text" id="partydt" placeholder="Party" />
          </div>
        </div>

        <tr>
          <td>
            <label for="issue-dt">Issue Date &emsp;</label>
            <input type="date" id="issue-dt" name="issue-dt" />
          </td>
          <td>
            <label for="due-dt">Due Date &emsp;</label>
            <input type="date" id="due-dt" name="due-dt" contenteditable />
          </td>
          <td>
            <label for="pon">P.O. Number</label>
            <input type="text" id="pon" name="pon" disabled contenteditable />
          </td>
        </tr>
      </table>
    </div>
    <div class="button-div">
      <button id="Add_item_button" type="button" onclick="">Add Item</button>
      <button id="Add_prty_button" type="button" onclick="">Add Party</button>
      <button
        type="button"
        class="add"
        onclick="addRowIfnotLastcolumnnotempty('myTable')"
      >
        <img src="../assets/images/addrow.png" />
      </button>
      <button type="button" id="delete-row" onclick="deleteRow()">
        <img src="../assets/images/reject2.png" />
      </button>
    </div>
    <div class="min_height">
      <table class="inventory" id="myTable">
        <thead>
          <tr>
            <th class="bold2" rowspan="2">
              <span class="no" id="no">#</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="item" id="item">ITEM</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="batch-no" id="batch-no">BATCH NO.</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="exp-date" id="exp-date">EXPIRY DATE</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="quantity" id="quantity">QUANTITY</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="unit" id="unit">UNIT</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="price/unit" id="price/unit">PRICE/UNIT</span>
            </th>
            <th class="bold" colspan="2">
              <span class="discount" id="discount">DISCOUNT</span>
            </th>
            <th class="bold" colspan="2">
              <span class="tax" id="tax">TAX</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="amount" id="amount">AMOUNT</span>
            </th>
            <!-- <th class="bold" rowspan="2">
              <span class="amount" id="mrp">MRP</span>
            </th> -->
          </tr>

          <tr>
            <th class="bold header">
              <span class="percentage" id="percentage">%</span>
            </th>
            <th class="bold header">
              <span class="disc-amount" id="disc-amount">AMOUNT</span>
            </th>
            <th class="bold header">
              <span class="percentage2" id="percentage2">%</span>
            </th>
            <th class="bold header">
              <span class="disc-amount2" id="disc-amount2">AMOUNT</span>
            </th>
          </tr>
        </thead>

        <tbody id="tbdy"></tbody>
      </table>
    </div>
    <!-- <div class="addrow">
      <a
        class="add noprint"
        title="Add Item"
        onclick="addRowIfnotLastcolumnnotempty('myTable')"
        >Add row</a
      >
    </div> -->
    <div class="right_tax">
      <div class="payment-method">
        <select name="cars" id="payment-select" placeholder=" " type="text">
          <option selected disabled hidden value="">Payment Method</option>
          <option value="upi">UPI</option>
          <option value="cash">Cash</option>
          <option value="bank">Bank</option>
        </select>
        <input id="file-input" type="file" />
      </div>
      <div class="description-down">
        <textarea placeholder="Description" id="desp"></textarea>
      </div>
      <table class="balance" id="balance">
        <tbody>
          <tr>
            <th class="bold1">
              <span class="total" id="disc">Discount</span>
            </th>
            <td class="disc_td">
              <input type="number" id="granddisc" oninput="getDiscount()" />
            </td>
            <th class="bold1">
              <span class="total" id="total">Total</span>
            </th>
            <td><span>&#8377; </span><span id="grandtotal"></span></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button type="button" id="save-submit-button" onclick="purchaseSubmit()">
      SAVE
    </button>
  </form>
</body>
<script>
  // window.electronAPI.setTitle("Purchase order");
  //event listerner for add_item button
  document.getElementById("Add_item_button").addEventListener("click", () => {
    window.opener.addStock();
  });
  document.getElementById("Add_prty_button").addEventListener("click", () => {
    window.opener.addVendor();
  });
  //vendor name dropdown and contextbridge
  window.MainDatastream.streampurchasepartyview((status, data) => {
    var vendor_name = JSON.parse(data).data;
    console.log("vendor data", JSON.parse(data).data);
    var list = document.getElementById("partydt");
    inflateAutoCompleateView(list, vendor_name);
  });

  //context bridge to select values from stock & stock_collection
  window.MainDatastream.streamAddBill(
    "SELECT stock.stock_id,stock_collection.product,stock.sales_price,stock.discount,stock.bach_no,stock.expiry,stock.unit,stock.item_description,stock_collection.tax_per FROM stock_collection LEFT JOIN stock ON stock_collection.product_id = stock.stock_f_id",
    (status, data) => {
      this.searchVal = JSON.parse(data).data;
      addRowIfnotLastcolumnnotempty("myTable");
      console.log("serachval=>", this.searchVal);
    }
  );

  document
    .getElementsByTagName("body")[0]
    .addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        console.log("keypress called");
        addRowIfnotLastcolumnnotempty("myTable");
        event.preventDefault();
      }
    });
  //creating receipt object
  var mReceipt = new Receipt();
  //when page is loaded one row is added
  function addRowIfnotLastcolumnnotempty(table_id) {
    var table = document.getElementById(table_id);
    console.log(
      "addRowIfnotLastcolumnnotempty ==> table row length vs reciept row length",
      table.rows.length - 2,
      mReceipt.getProducts().length
    );
    if (table.rows.length - 2 == mReceipt.getProducts().length) {
      CreateRow(table_id);
    }
  }
  //delete row function
  var saleTable = document.getElementById("myTable");
  var sale_tbody = document.getElementById("tbdy");
  var numberofselectedrows = 0;
  var deleteIndex = [];
  function deleteRow() {
    numberofselectedrows = 0;
    document.getElementById("delete-row").style.display = "none";
    for (var i = 2; i < saleTable.rows.length; i++) {
      if (saleTable.rows[i].cells[0].firstChild.checked) {
        deleteIndex.push(i);
      }
    }
    for (var i = deleteIndex.length - 1; i > -1; i--) {
      saleTable.rows[deleteIndex[i]].remove();
      mReceipt.deleteProduct(deleteIndex[i] - 2);
    }
    deleteIndex = [];
    gTotal.innerHTML = mReceipt.getGrandTotal();
  }
  //function to create row

  function CreateRow(table_id) {
    var table = document.getElementById(table_id);
    var t_body = document.getElementById("tbdy");
    var row = t_body.insertRow(table.rows.length - 2);

    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);

    var cell5 = row.insertCell(4);
    var cell6 = row.insertCell(5);
    var cell7 = row.insertCell(6);
    var cell8 = row.insertCell(7);
    var cell9 = row.insertCell(8);
    var cell10 = row.insertCell(9);
    var cell11 = row.insertCell(10);
    var cell12 = row.insertCell(11);
    // var cell13 = row.insertCell(12);
    cell1.append(createInputCheckbox("cell1"));
    cell2.append(createInputtext());
    cell3.append(createInputtext());
    cell4.append(createInputtextDisabled());
    cell5.append(createInputNumber());
    cell6.append(createInputtextDisabled());
    cell7.append(createInputNumber());
    cell8.append(createInputNumber());
    cell9.append(createInputNumber());
    cell10.append(createInputSelect());
    cell11.append(createInputNumber());
    cell12.append(createInputNumber());
    // cell13.append(createInputNumber());
    table.oninput = (event) => {
      updateProduct(event);
    };
    console.log("searchval value inside createrow=>", this.searchVal);

    inflateAutoCompleateView(
      table.rows[table.rows.length - 1].cells[1].firstChild,
      this.searchVal,
      table.rows.length,
      (product, rowIndex) => {
        rowIndex = rowIndex - 1;

        console.log("selected product ==> ", product, " ", rowIndex);
        var a = document.getElementById("myTable");
        var gTotal = document.getElementById("grandtotal");
        a.rows[rowIndex].cells[2].firstChild.disabled = false;
        a.rows[rowIndex].cells[3].firstChild.disabled = false;
        a.rows[rowIndex].cells[4].firstChild.disabled = false;
        a.rows[rowIndex].cells[5].firstChild.disabled = false;
        a.rows[rowIndex].cells[6].firstChild.disabled = false;
        a.rows[rowIndex].cells[7].firstChild.disabled = false;
        a.rows[rowIndex].cells[8].firstChild.disabled = false;
        a.rows[rowIndex].cells[9].firstChild.disabled = false;

        console.log("column filled", product);
        var p = new Product(
          product[0],
          product[1],
          product[6],
          product[2],
          product[3],
          product[8],
          product[7],
          product[4],
          product[5]
        );
        mReceipt.addproduct(p);
        selectColumnFill(product, a, rowIndex);

        console.log(
          "total amount when item is added=>",
          mReceipt.getProducts()[rowIndex - 2].getTotal()
        );
      }
    );
  }

  function createInputCheckbox(id) {
    var checkType = document.createElement("input");
    checkType.type = "checkbox";
    checkType.id = id;
    checkType.addEventListener("click", (event) => {
      if (event.target.checked) {
        numberofselectedrows++;
      } else {
        numberofselectedrows--;
      }
      if (numberofselectedrows > 0) {
        document.getElementById("delete-row").style.display = "inline-block";
      } else {
        document.getElementById("delete-row").style.display = "none";
      }
    });
    return checkType;
  }

  function createInputtext() {
    var textType = document.createElement("input");
    textType.type = "text";

    return textType;
  }
  function createInputtextDisabled() {
    var textType = document.createElement("input");
    textType.type = "text";
    textType.disabled = true;
    return textType;
  }
  function createInputNumber() {
    var numType = document.createElement("input");
    numType.type = "number";
    numType.min = "0";
    numType.disabled = true;

    return numType;
  }

  function createInputSelect() {
    var SelectType = document.createElement("select");
    SelectType.disabled = true;
    var selectarray = [0, 5, 12, 18, 28];

    for (var i = 0; i < 5; i++) {
      var optionApp = document.createElement("option");
      optionApp.value = selectarray[i];
      optionApp.innerHTML = selectarray[i];
      SelectType.appendChild(optionApp);
    }
    return SelectType;
  }

  var gTotal = document.getElementById("grandtotal");
  function updateProduct(event) {
    let cell = event.target;
    var rowIndex = cell.parentNode.parentNode.rowIndex;
    var cellIndex = cell.parentNode.cellIndex;
    var a = document.getElementById("myTable");

    switch (cellIndex) {
      case 2:
        mReceipt
          .getProducts()
          [rowIndex - 2].setbatch(a.rows[rowIndex].cells[2].firstChild.value);
        break;
      case 3:
        mReceipt
          .getProducts()
          [rowIndex - 2].setExpiry(a.rows[rowIndex].cells[3].firstChild.value);
        break;
      case 4:
        mReceipt
          .getProducts()
          [rowIndex - 2].setQuantity(
            a.rows[rowIndex].cells[4].firstChild.value
          );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 5:
        mReceipt
          .getProducts()
          [rowIndex - 2].setUnit(a.rows[rowIndex].cells[5].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 6:
        mReceipt
          .getProducts()
          [rowIndex - 2].setPrice(a.rows[rowIndex].cells[6].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 7:
        mReceipt
          .getProducts()
          [rowIndex - 2].setDiscount(
            a.rows[rowIndex].cells[7].firstChild.value
          );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 8:
        console.log(
          "discount amount changed",
          (a.rows[rowIndex].cells[8].firstChild.value /
            mReceipt.getProducts()[rowIndex - 2].getTotalPrice()) *
            100
        );
        a.rows[rowIndex].cells[7].firstChild.value =
          Math.round(
            (a.rows[rowIndex].cells[8].firstChild.value /
              mReceipt.getProducts()[rowIndex - 2].getTotalPrice()) *
              100 *
              1e2
          ) / 1e2;

        mReceipt
          .getProducts()
          [rowIndex - 2].setDiscount(
            a.rows[rowIndex].cells[7].firstChild.value
          );
        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();

        break;
      case 9:
        mReceipt
          .getProducts()
          [rowIndex - 2].setTax(a.rows[rowIndex].cells[9].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
    }
  }

  window.MainDatastream.streamAddBill(
    "SELECT order_id FROM purchase_order ORDER BY order_id DESC LIMIT 1 ;",
    (status, data) => {
      document.getElementById("pon").value =
        parseInt(JSON.parse(data).data[0]) + 1;
    }
  );

  function selectColumnFill(product, a, rowIndex) {
    //batch_no
    (a.rows[rowIndex].cells[2].firstChild.value = product[4]),
      //expiry_date
      (a.rows[rowIndex].cells[3].firstChild.value = product[5]),
      //unit
      (a.rows[rowIndex].cells[5].firstChild.value = product[6]),
      //price
      (a.rows[rowIndex].cells[6].firstChild.value = product[2]),
      //discount
      (a.rows[rowIndex].cells[7].firstChild.value = product[3]),
      //discount amount
      (a.rows[rowIndex].cells[8].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getDiscountamount()),
      //tax
      (a.rows[rowIndex].cells[9].firstChild.value = product[8]),
      //tax amount
      (a.rows[rowIndex].cells[10].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getTaxAmount()),
      //total amount
      (a.rows[rowIndex].cells[11].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getTotal()),
      //quantity
      (a.rows[rowIndex].cells[4].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getQuantity()),
      //grandTotal
      (gTotal.innerHTML = mReceipt.getGrandTotal());
  }

  //============================================
  function currentDate(datId) {
    datId.valueAsDate = new Date();
  }
  currentDate(document.getElementById("issue-dt"));

  function getDiscount() {
    mReceipt.setDiscount(document.getElementById("granddisc").value);
    gTotal.innerHTML = mReceipt.getGrandTotal();
  }

  document
    .getElementById("save-submit-button")
    .addEventListener("click", console.log("save event called"));
  function purchaseSubmit() {
    var reciept_n = document.getElementById("pon").value;
    var table_data = document.getElementById("myTable");
    var issue_date_po = document.getElementById("issue-dt").value;
    var due_date_po = document.getElementById("due-dt").value;
    var pay_method_po = document.getElementById("payment-select").value;
    var party_id = document.getElementById("partydt").selectedItemId;
    console.log("selecteditemid=>", party_id);
    var desp = document.getElementById("desp").value;

    var disc = document.getElementById("granddisc").value;

    mReceipt.setReceipt(reciept_n);
    mReceipt.setDate(issue_date_po);

    var po_sql_query =
      "INSERT INTO purchase_order (vendor_f_id,po_date,due_date,payment_method,discount,description,total_amount)";

    var po_data =
      "('" +
      party_id +
      "','" +
      issue_date_po +
      "','" +
      due_date_po +
      "','" +
      pay_method_po +
      "','" +
      disc +
      "','" +
      desp +
      "','" +
      mReceipt.getGrandTotal() +
      "')";
    console.log("po_data=>", po_data);
    window.MainDatastream.streamAddPurchaseOrder(
      po_sql_query,
      po_data,
      (status, data) => {
        console.log("purchase return=>", status, JSON.parse(data));
        purchaseOrderlistSubmit(JSON.parse(data)[0][0]);
      }
    );
  }

  function purchaseOrderlistSubmit(purId) {
    var data_value = mReceipt.getProducts();

    var purchaseBillDetails = "";
    for (var i = 0; i < data_value.length; i++) {
      purchaseBillDetails +=
        "('" +
        purId +
        "','" +
        data_value[i].getName() +
        "','" +
        data_value[i].getUnit() +
        "','" +
        data_value[i].getId() +
        "','" +
        data_value[i].getPrice() +
        "','" +
        data_value[i].getQuantity() +
        "','" +
        data_value[i].getDiscount() +
        "','" +
        data_value[i].getTax() +
        "','" +
        data_value[i].getTotal() +
        "','" +
        data_value[i].getexpiry() +
        "','" +
        data_value[i].getbatch_no() +
        "')";
      if (i < data_value.length - 1) {
        purchaseBillDetails += ",";
      }
    }
    console.log("value=>", purchaseBillDetails);
    var purbilllistSqlQuery =
      "INSERT INTO purchase_order_list(pur_order_f_key ,stock_name,unit,stock_f_key,price_unit,quantity,disc_ount,tax,amount,expiry_date,batch_no)";

    window.MainDatastream.streamAddStock(
      purbilllistSqlQuery,
      purchaseBillDetails,
      (status, data) => {
        console.log("addstock", status, data);
      }
    );

    location.reload("true");
  }
</script>
