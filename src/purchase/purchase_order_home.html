<link rel="stylesheet" href="../assets/themes/purchase_order_home.css" />

<style></style>
<div class="container1" id="container1">
  <div id="tabwrap"></div>

  <div id="header"></div>
</div>
<div class="container" id="qwe">
  <!-- <div class="table1-div">
    <br />
    
    <button id="add-purchase-order" onclick="openPO()">
      <span>Add Purchase Order</span>
    </button>
  </div> -->
  <input
    type="text"
    id="filter-text-box"
    placeholder="Type a keyword.."
    oninput="onFilterTextBoxChanged()"
  />
  <div id="wrapper1" class="ag-theme-alpine">
    <div id="snackbar" class="snackbar">Deleted</div>
  </div>
</div>
<script>
  SnackboxAlertStyle();
  PurHomeactionbar = new Actionbar();

  PurHomeactionbar.addIcon(
    "add_expense",
    "../assets/images/add-expense.png",
    "New purchase order"
  );

  PurHomeactionbar.addIcon(
    "print_button",
    "../assets/images/toolbar-print.png",
    "Print"
  );
  PurHomeactionbar.addIcon(
    "export_button",
    ".././assets/images/export_excel-img.png",
    "export"
  );
  PurHomeactionbar.addIcon(
    "edit_button",
    ".././assets/images/editing.png",
    "Edit"
  );
  PurHomeactionbar.addIcon(
    "convert_button",
    ".././assets/images/convert.png",
    "Convert"
  );
  PurHomeactionbar.addIcon(
    "delete_button",
    ".././assets/images/delete.png",
    "Delete"
  );

  function handler(event) {
    switch (event.target.id) {
      case "add_expense":
        openPO();
        break;
      case "export_button":
        download();
        break;
      case "import_button":
        break;
      case "edit_button":
        btnClickedHandleEdit();
        break;
      case "convert_button":
        btnClickedHandlerConvert();
        break;
      case "delete_button":
        delOrder();
        break;
    }
  }
  PurHomeactionbar.render(document.getElementById("header"));
  PurHomeactionbar.setToolbarOnClick(handler);
  document.getElementById("print_button").style.display = "none";
  document.getElementById("edit_button").style.display = "none";
  document.getElementById("delete_button").style.display = "none";
  document.getElementById("convert_button").style.display = "none";
  var PurHomeTab;
  if (PurHomeTab == undefined) {
    PurHomeTab = new Tabbar();
    PurHomeTab.addTab("purchse_head", "Purchase");
  }
  PurHomeTab.render(document.getElementById("tabwrap"));

  function setDime(w, h) {
    if (w != undefined) {
      $("#wrapper1").css("width", (w * 96.3) / 100);
      $("#wrapper1").css("height", (h * 87.3) / 100);
    } else console.log("dime not defined");
  }
  //==============================================================
  function delOrder() {
    const selectedRows = gridOptions.api.getSelectedRows();
    console.log("row selected on ag grid", selectedRows[0]);
    if (selectedRows.length) {
      for (var i = 0; i < selectedRows.length; i++) {
        var sqlQuery =
          "UPDATE purchase_order SET is_deleted='1' WHERE purchase_order.order_id=" +
          selectedRows[i][1] +
          ";";
        var value;
        console.log("deleted value queries=>", sqlQuery);
        window.MainDatastream.streamAddData(
          sqlQuery,
          value,
          (status, data) => {}
        );
      }
      SnackboxAlert("snackbar");
    }
  }
  function btnClickedHandlerConvert() {
    const selectedRows = gridOptions.api.getSelectedRows();
    if (selectedRows.length == 1) {
      window.open(
        "./purchase_bill.html?data=" +
          encodeURIComponent(JSON.stringify([selectedRows[0][1], "convert"])),
        "-blank",
        "resizable=0,frame=0," +
          "width=" +
          getWidth() +
          ",height=" + 
          getHeight()
      );
      console.log("purchase home val=>", selectedRows[0][1]);
    }
  }
  function btnClickedHandleEdit() {
    const selectedRows = gridOptions.api.getSelectedRows();
    if (selectedRows.length == 1) {
      window.open(
        "./purchase_bill.html?data=" +
          encodeURIComponent(JSON.stringify([selectedRows[0][1], "edit"])),
        "-blank",
        "resizable=0,frame=0," +
          "width=" +
          getWidth() +
          ",height=" +
          getHeight()
      );
      console.log("purchase home val=>", selectedRows[0][1]);
    }
  }

  try {
    setDime(window.screen.availWidth, window.screen.availHeight);
  } catch (err) {
    console.log("-dime not defined");
  }

  var clickdata_id;
  function onFilterTextBoxChanged() {
    gridOptions.api.setQuickFilter(
      document.getElementById("filter-text-box").value
    );
  }
  // var BtnRenderer;
  // if (typeof BtnRenderer !== "function") {
  //   BtnRenderer = class {
  //     init(params) {
  //       this.params = params;
  //       this.eGui = document.createElement("div");
  //       this.eGui.classList.add("custom-element");
  //       this.button1 = document.createElement("img");
  //       this.button2 = document.createElement("img");
  //       this.button3 = document.createElement("img");

  //       this.button1.id = "Approve_Button";
  //       this.button2.id = "Reject_Button";
  //       this.button3.id = "edit_Button";

  //       this.button1.src = ".././assets/images/approve-tick.png";
  //       this.button2.src = ".././assets/images/trash-icon.png";
  //       this.button3.src = ".././assets/images/edit-eye.png";
  //       this.btnClickedHandlerConvert =
  //         this.btnClickedHandlerConvert.bind(this);
  //       this.btnClickedHandleEdit = this.btnClickedHandleEdit.bind(this);
  //       this.btnClickedHandlerDelete = this.btnClickedHandlerDelete.bind(this);
  //       this.button1.addEventListener("click", this.btnClickedHandlerConvert);
  //       this.button2.addEventListener("click", this.btnClickedHandlerDelete);
  //       this.button3.addEventListener("click", this.btnClickedHandleEdit);
  //       this.eGui.appendChild(this.button3);
  //       this.eGui.appendChild(this.button1);
  //       this.eGui.appendChild(this.button2);
  //     }

  //     getGui() {
  //       return this.eGui;
  //     }

  //     btnClickedHandlerConvert(event) {
  //       this.params.clicked(this.params.value);

  //       window.open(
  //         "./purchase_bill.html?data=" +
  //           encodeURIComponent(
  //             JSON.stringify([this.params.data[1], "convert"])
  //           ),
  //         "-blank",
  //         "resizable=0,frame=0," +
  //           "width=" +
  //           getWidth() +
  //           ",height=" +
  //           getHeight()
  //       );
  //       console.log("purchase home val=>", this.params.data[1]);
  //     }
  //     btnClickedHandleEdit(event) {
  //       this.params.clicked(this.params.value);
  //       window.open(
  //         "./purchase_bill.html?data=" +
  //           encodeURIComponent(JSON.stringify([this.params.data[1], "edit"])),
  //         "-blank",
  //         "resizable=0,frame=0," +
  //           "width=" +
  //           getWidth() +
  //           ",height=" +
  //           getHeight()
  //       );
  //       console.log("purchase home val=>", this.params.data[1]);
  //     }
  //     btnClickedHandlerDelete(event) {
  //       var clickdata_id1;
  //       this.params.clicked(this.params.value);
  //       clickdata_id1 = this.params.data[1];
  //       var sqlQuery =
  //         "UPDATE purchase_order SET is_deleted='1' WHERE purchase_order.order_id=" +
  //         clickdata_id1 +
  //         ";";
  //       var value;
  //       window.MainDatastream.streamAddData(
  //         sqlQuery,
  //         value,
  //         (status, data) => {}
  //       );
  //       SnackboxAlert("snackbar");
  //     }

  //     destroy() {
  //       this.eGui.removeEventListener("click", this.btnClickedHandler);
  //     }
  //   };
  // }

  var gridOptions = {
    // define 3 columns
    columnDefs: [
      {
        headerName: "SLN",
        valueGetter: "node.rowIndex + 1",
        resizable: true,
        // headerCheckboxSelection: true,
        // checkboxSelection: true,
        // showDisabledCheckboxes: true,
      },
      { headerName: "Party", field: "0", resizable: true },
      { headerName: "Order No", field: "1", resizable: true },
      { headerName: "Date", field: "2", resizable: true },
      {
        headerName: "Due Date",
        field: "3",
        resizable: true,
        floatingFilter: true,
        floatingFilterComponentParams: {
          suppressFilterButton: true,
        },
      },
      { headerName: "Total Amount", field: "4", resizable: true },
      { headerName: "Payment Type", field: "5", resizable: true },
      { headerName: "Status", field: "6", resizable: true },
      // {
      //   headerName: "Action",
      //   field: "7",
      //   resizable: true,
      //   // cellRenderer: BtnRenderer,
      //   cellRendererParams: {
      //     clicked: function (field) {},
      //   },
      // },
    ],

    // getSelectedRows: 'getSelectedRows',
    // cellClicked:'onCellClicked',
    // onSelectionChanged: 'onSelectionChanged',
    rowSelection: "multiple",
    // suppressRowClickSelection: true,
    onRowSelected: onRowSelected,
    onRowDoubleClicked: openpurchaseorder,
    onFirstDataRendered: onFirstDataRendered,
    defaultColDef: { sortable: true },
    pagination: true,
    paginationPageSize: 10,

    animateRows: true,
  };
  function onRowSelected() {
    const selectedRows = gridOptions.api.getSelectedRows();
    if (selectedRows) {
      console.log(" row selected");
      document.getElementById("delete_button").style.display = "flex";
      document.getElementById("export_button").style.display = "flex";
      // document.getElementById("import_button").style.display = "flex";
      document.getElementById("print_button").style.display = "flex";
      document.getElementById("edit_button").style.display = "flex";
      document.getElementById("convert_button").style.display = "flex";
      if (selectedRows.length > 1) {
        console.log("more than one row selected function called");
        document.getElementById("export_button").style.display = "none";
        // document.getElementById("import_button").style.display = "none";
        document.getElementById("print_button").style.display = "none";
        document.getElementById("edit_button").style.display = "none";
        // document.getElementById("convert_button").style.display = "none";
      }
    }
  }
  function openpurchaseorder(event) {
    window.open(
      "./purchase_bill.html?data=" +
        encodeURIComponent(JSON.stringify([event.node.data[1], "editing"])),
      "_blank",
      "resizable=0,frame=0," + "width=" + getWidth() + ",height=" + getHeight()
    );
  }
  function onFirstDataRendered(params) {
    params.api.sizeColumnsToFit();
  }
  function onSelection() {
    const selectedRows = gridOptions.api.getSelectedRows();
    selectedRows.length === 1 ? selectedRows[0] : "";
  }

  var GridDiv = document.getElementById("wrapper1");
  new agGrid.Grid(GridDiv, gridOptions);

  window.MainDatastream.streampurchasehomeview((status, data) => {
    this.purchaseorderdata = JSON.parse(data).data;
    gridOptions.api.setRowData(JSON.parse(data).data);
  });

  window.electronAPI.setTitle("PURCHASE ORDER");

  function onFilterTextBoxChanged() {
    gridOptions.api.setQuickFilter(
      document.getElementById("filter-text-box").value
    );
  }

  var inp = document.createElement("input");
  var root = document.getElementsByClassName("ag-header-row-column-filter");
  inp.id = "filter-text-box";
  inp.type = "text";
  inp.placeholder = "Type a keyword..";
  inp.oninput = function () {
    onFilterTextBoxChanged();
  };
  root[0].appendChild(inp);
  function download() {
    console.log("this.labourdata with amount", this.purchaseorderdata);

    var header = [
      [
        "Party",
        "No",
        "Date",
        "Due Date",
        "Total Amount",
        "Payment Type",
        "Status",
      ],
    ];
    window.ExcelDatastream.Exceldata(
      this.purchaseorderdata,
      header,
      (data, header) => {}
    );
  }

  // import_button = document.getElementById("import_button");
  // import_button.addEventListener("click", async () => {
  //   const filepath = await window.ExcelDatastream.ExcelImportClick();
  //   console.log("filepath", filepath);
  // });
</script>
