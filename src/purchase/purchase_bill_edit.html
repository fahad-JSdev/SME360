<script src="../../node_modules/jquery/dist/jquery.min.js"></script>

<script src="../widgets/autoSearchText.js"></script>
<link rel="stylesheet" href="../assets/themes/autoSearchText.css" />
<link rel="stylesheet" href="../assets/themes/purchase_order.css" />
<script src="../accounts/Product.js"></script>
<script src="../accounts/Receipt.js"></script>
<script src="../widgets/snackbox.js"></script>
<body>
  <center><span class="purchase_bill">PURCHASE BILL</span></center>
  <form id="main-form">
    <div class="client">
      <table class="top-table">
        <div class="container1">
          <div class="material-textfield">
            <input type="text" id="partydt" placeholder="Party" />
          </div>
        </div>
        <tr>
          <td id="pbdtecolumn">
            <label for="pbdate"> bill Date &emsp;</label>
            <input type="date" id="pbdate" name="pbdate" />
          </td>
          <!-- <td id="podtecolumn">
            <label for="issue-dt"> Order Date &emsp;</label>
            <input type="date" id="issue-dt" name="issue-dt" />
          </td>

          <td>
            <label for="due-dt">Due Date &emsp;</label>
            <input type="date" id="due-dt" name="due-dt" contenteditable />
          </td>
          <td id="poNumber">
            <label for="pon">P.O. Number</label>
            <input type="text" id="pon" name="pon" disabled contenteditable />
          </td> -->
          <td id="pbNumber">
            <label for="pBnumber">P.B. Number</label>
            <input
              type="text"
              id="pBnumber"
              name="pon"
              disabled
              contenteditable
            />
          </td>
        </tr>
      </table>
    </div>
    <div class="button-div">
      <button
        type="button"
        class="add"
        onclick="addRowIfnotLastcolumnnotempty('myTable')"
      >
        <img src="../assets/images/addrow.png" />
      </button>
      <button type="button" id="delete-row" onclick="deleteRow()">
        <img src="../assets/images/reject2.png" />
      </button>
      <img
        src="../assets/images/print3.png"
        alt="print button"
        id="print_button"
        class="print_button"
        title="print"
        onclick=""
      />
      <img
        src="../assets/images/trash.png"
        alt="delete button"
        id="delete_button"
        class="edit_button"
        title="delete"
        onclick="deleteFunction()"
      />
      <img
        src="../assets/images/approved.png"
        alt="approve button"
        id="approve_button"
        class="approve_button"
        title="approve"
        onclick="approveFunction()"
      />
      <img
        src="../assets/images/color_edit.png"
        alt="edit button"
        id="edit_button"
        class="edit_button"
        title="Edit"
        onclick="editing()"
      />
    </div>
    <div class="min_height">
      <table class="inventory" id="myTable">
        <thead>
          <tr>
            <th class="bold2" rowspan="2">
              <span class="no" id="no">#</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="item" id="item">ITEM</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="batch-no" id="batch-no">BATCH NO.</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="exp-date" id="exp-date">EXPIRY DATE</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="quantity" id="quantity">QUANTITY</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="unit" id="unit">UNIT</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="price/unit" id="price/unit">PRICE/UNIT</span>
            </th>
            <th class="bold" colspan="2">
              <span class="discount" id="discount">DISCOUNT</span>
            </th>
            <th class="bold" colspan="2">
              <span class="tax" id="tax">TAX</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="amount" id="amount">AMOUNT</span>
            </th>
          </tr>

          <tr>
            <th class="bold header">
              <span class="percentage" id="percentage">%</span>
            </th>
            <th class="bold header">
              <span class="disc-amount" id="disc-amount">AMOUNT</span>
            </th>
            <th class="bold header">
              <span class="percentage2" id="percentage2">%</span>
            </th>
            <th class="bold header">
              <span class="disc-amount2" id="disc-amount2">AMOUNT</span>
            </th>
          </tr>
        </thead>

        <tbody id="tbdy"></tbody>
      </table>
    </div>
    <!-- <div class="addrow">
      <a
        class="add noprint"
        title="Add Item"
        onclick="addRowIfnotLastcolumnnotempty('myTable')"
        >Add row</a
      >
    </div> -->
    <div class="right_tax">
      <div class="payment-method">
        <select name="cars" id="payment-select" placeholder=" " type="text">
          <option selected disabled hidden>Payment Method</option>
          <option value="upi">UPI</option>
          <option value="cash">Cash</option>
          <option value="bank">Bank</option>
        </select>
        <input id="file-input" type="file" />
      </div>
      <div class="description-down">
        <textarea placeholder="Description" id="desp"></textarea>
      </div>
      <table class="balance" id="balance">
        <tbody>
          <tr>
            <th class="bold1">
              <span class="total" id="disc">Discount</span>
            </th>
            <td class="disc_td">
              <input type="number" id="granddisc" oninput="getDiscount()" />
            </td>
            <th class="bold1">
              <span class="total" id="total">Total</span>
            </th>
            <td><span>&#8377; </span><span id="grandtotal"></span></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button
      type="button"
      id="save-submit-button"
      onclick="purchaseOrderUpdate()"
    >
      SAVE
    </button>
    <div id="snackbar" class="snackbar">Updated</div>
  </form>
</body>

<script>
  SnackboxAlertStyle();
  function getWidth() {
    return window.screen.availWidth;
  }
  function getHeight() {
    return window.screen.availHeight;
  }
  var edit_button = document.getElementById("edit_button");
  var delete_button = document.getElementById("delete_button");
  var aprove_button = document.getElementById("approve_button");
  var print_button = document.getElementById("print_button");
  edit_button.style.display = "none";
  delete_button.style.display = "none";
  aprove_button.style.display = "none";
  print_button.style.display = "none";

  //event listerner for add_item button

  //vendor name dropdown and contextbridge
  // window.MainDatastream.streampurchasepartyview((status, data) => {
  //   var vendor_name = JSON.parse(data).data;
  //   console.log("vendor data", JSON.parse(data).data);
  //   var list = document.getElementById("partydt");
  //   inflateAutoCompleateView(list, vendor_name);
  // });
  var a = document.getElementById("myTable");
  var mReceipt = new Receipt();
  const urlParams = new URLSearchParams(window.location.search);
  const dataString = urlParams.get("data");
  var clickdata_id = JSON.parse(decodeURIComponent(dataString));
  console.log("data from purchase orderhome=>", clickdata_id, clickdata_id[0]);
  if (clickdata_id[1] == "billediting") {
    console.log("billlllllllllllllllllllllllllll");
    edit_button.style.display = "block";
    delete_button.style.display = "block";
    aprove_button.style.display = "block";
    print_button.style.display = "block";
    document.getElementById("save-submit-button").style.display = "none";
  }
  var payment = document.getElementById("payment-select");
  var partydt = document.getElementById("partydt");
  var desp = document.getElementById("desp");
  var disc = document.getElementById("granddisc");
  var gTotal = document.getElementById("grandtotal");
  window.MainDatastream.streamGetDataOnce(
    "SELECT purchase_bill.bill_id,purchase_bill.pb_dat,purchase_bill.due_dat,purchase_bill.total_amnt,purchase_bill.bill_discount,purchase_bill.bill_pay_method,purchase_bill.bill_description,pur_bill_list.list_stockname,pur_bill_list.list_batch,pur_bill_list.exp_dat,pur_bill_list.list_quantity,pur_bill_list.list_unit,pur_bill_list.list_price,pur_bill_list.list_tax,pur_bill_list.list_amount,vendor.vendor_name,pur_bill_list.list_discount,stock.item_description,stock.stock_id,pur_bill_list.list_id,pur_bill_list.return FROM purchase_bill LEFT JOIN vendor ON purchase_bill.vendor_f_id = vendor.personid LEFT JOIN purchase_bill_list AS pur_bill_list ON purchase_bill.bill_id = pur_bill_list.pur_bill_f_key LEFT JOIN stock ON pur_bill_list.stock_f_key = stock.stock_id WHERE purchase_bill.bill_id=" +
      clickdata_id[0] +
      ";",
    (status, data) => {
      this.rowLength = JSON.parse(data).data.length;

      console.log("data for purchase bill table=>", JSON.parse(data).data);
      var pon = document.getElementById("pBnumber");

      var issue = document.getElementById("pbdate");
      // var bill_dat = document.getElementById("bill_dat");

      pon.value = JSON.parse(data).data[0][0];
      issue.value = JSON.parse(data).data[0][1];

      // bill_dat.value = JSON.parse(data).data[0][2];
      payment.value = JSON.parse(data).data[0][5];
      partydt.value = JSON.parse(data).data[0][15];
      console.log("payment value=>", JSON.parse(data).data[0][5]);
      console.log("description value=>", JSON.parse(data).data[0][6]);
      console.log("discount value=>", JSON.parse(data).data[0][4]);
      desp.value = JSON.parse(data).data[0][6];
      disc.value = JSON.parse(data).data[0][4];
      gTotal.innerHTML = JSON.parse(data).data[0][3];
      // partydt.selectedItemId = JSON.parse(data).data[0][21];
      partydt.disabled = true;
      issue.disabled = true;
      if (clickdata_id[1] == "billediting") {
        payment.disabled = true;
        gTotal.disabled = true;
        disc.disabled = true;
        desp.disabled = true;
      }
      for (var i = 0; i < JSON.parse(data).data.length; i++) {
        CreateRow("myTable");

        console.log("row created", i + 2);

        // console.log("table data=>", JSON.parse(data).data[i]);
        a.rows[i + 2].cells[1].firstChild.value = JSON.parse(data).data[i][7];
        a.rows[i + 2].cells[1].firstChild.stockId =
          JSON.parse(data).data[i][18];
        a.rows[i + 2].cells[1].firstChild.listId = JSON.parse(data).data[i][19];
        a.rows[i + 2].cells[2].firstChild.value = JSON.parse(data).data[i][8];
        a.rows[i + 2].cells[3].firstChild.value = JSON.parse(data).data[i][9];
        a.rows[i + 2].cells[4].firstChild.value = JSON.parse(data).data[i][10];
        a.rows[i + 2].cells[5].firstChild.value = JSON.parse(data).data[i][11];
        a.rows[i + 2].cells[6].firstChild.value = JSON.parse(data).data[i][12];
        a.rows[i + 2].cells[7].firstChild.value = JSON.parse(data).data[i][16];
        a.rows[i + 2].cells[9].firstChild.value = JSON.parse(data).data[i][13];
        a.rows[i + 2].cells[11].firstChild.value = JSON.parse(data).data[i][14];
        console.log("total value=>", JSON.parse(data).data[i][14]);
        console.log("return function", JSON.parse(data).data[i]);

        a.rows[i + 2].cells[1].firstChild.disabled = true;
        a.rows[i + 2].cells[2].firstChild.disabled = true;
        a.rows[i + 2].cells[3].firstChild.disabled = true;
        a.rows[i + 2].cells[4].firstChild.disabled = true;
        a.rows[i + 2].cells[5].firstChild.disabled = false;
        a.rows[i + 2].cells[6].firstChild.disabled = true;
        a.rows[i + 2].cells[7].firstChild.disabled = true;
        a.rows[i + 2].cells[8].firstChild.disabled = true;
        a.rows[i + 2].cells[9].firstChild.disabled = true;

        var p = new Product(
          //stock_id //list_id
          [JSON.parse(data).data[i][18], JSON.parse(data).data[i][19]], // id
          JSON.parse(data).data[i][7], //name
          JSON.parse(data).data[i][11], //unit
          parseFloat(JSON.parse(data).data[i][12]), //price
          parseFloat(JSON.parse(data).data[i][16]), //discount
          parseFloat(JSON.parse(data).data[i][13]), //tax
          JSON.parse(data).data[i][17], //details
          JSON.parse(data).data[i][8], //batch_no
          JSON.parse(data).data[i][9] //expiry_dat
        );
        mReceipt.addproduct(p);
        mReceipt
          .getProducts()
          [i].setQuantity(parseFloat(JSON.parse(data).data[i][10]));
        a.rows[i + 2].cells[9].firstChild.value = mReceipt
          .getProducts()
          [i].getDiscountamount();
        a.rows[i + 2].cells[11].firstChild.value = mReceipt
          .getProducts()
          [i].getTaxAmount();
        if (clickdata_id[1] == "billedit") {
          a.rows[i + 2].cells[1].firstChild.disabled = true;
          a.rows[i + 2].cells[2].firstChild.disabled = false;
          a.rows[i + 2].cells[3].firstChild.disabled = false;
          a.rows[i + 2].cells[4].firstChild.disabled = false;
          a.rows[i + 2].cells[5].firstChild.disabled = false;
          a.rows[i + 2].cells[6].firstChild.disabled = false;
          a.rows[i + 2].cells[7].firstChild.disabled = false;
          a.rows[i + 2].cells[8].firstChild.disabled = false;
          a.rows[i + 2].cells[9].firstChild.disabled = false;
        }
        if (clickdata_id[1] == "billediting") {
          a.rows[i + 2].cells[1].firstChild.disabled = true;
          a.rows[i + 2].cells[2].firstChild.disabled = true;
          a.rows[i + 2].cells[3].firstChild.disabled = true;
          a.rows[i + 2].cells[4].firstChild.disabled = true;
          a.rows[i + 2].cells[5].firstChild.disabled = true;
          a.rows[i + 2].cells[6].firstChild.disabled = true;
          a.rows[i + 2].cells[7].firstChild.disabled = true;
          a.rows[i + 2].cells[8].firstChild.disabled = true;
          a.rows[i + 2].cells[9].firstChild.disabled = true;
        }
      }
    }
  );
  function editing() {
    for (var i = 0; i < a.rows.length - 2; i++) {
      a.rows[i + 2].cells[1].firstChild.disabled = true;
      a.rows[i + 2].cells[2].firstChild.disabled = false;
      a.rows[i + 2].cells[3].firstChild.disabled = false;
      a.rows[i + 2].cells[4].firstChild.disabled = false;
      a.rows[i + 2].cells[5].firstChild.disabled = false;
      a.rows[i + 2].cells[6].firstChild.disabled = false;
      a.rows[i + 2].cells[7].firstChild.disabled = false;
      a.rows[i + 2].cells[8].firstChild.disabled = false;
      a.rows[i + 2].cells[9].firstChild.disabled = false;
    }
    payment.disabled = false;
    gTotal.disabled = false;
    disc.disabled = false;
    desp.disabled = false;
    document.getElementById("save-submit-button").innerText = "Edit";
    document.getElementById("save-submit-button").style.display = "block";
    edit_button.style.display = "none";
    delete_button.style.display = "none";
    aprove_button.style.display = "none";
    print_button.style.display = "none";
  }
  function deleteFunction() {
    var sqlQuery =
      "UPDATE purchase_bill SET is_deleted='1' WHERE purchase_bill.bill_id=" +
      clickdata_id[0] +
      ";";
    console.log("delete query", sqlQuery);
    var value;
    window.MainDatastream.streamAddData(sqlQuery, value, (status, data) => {});
    window.close();
  }
  function approveFunction() {
    var w = window.open(
      "./purchase_return.html?data=" +
        encodeURIComponent(JSON.stringify([clickdata_id[0], "return"])),
      "_self",
      "resizable=0,frame=0," + "width=" + getWidth() + ",height=" + getHeight()
    );
  }
  //context bridge to select values from stock & stock_collection
  window.MainDatastream.streamGetData(
    "SELECT stock.stock_id,stock_collection.product,stock.sales_price,stock.discount,stock.bach_no,stock.expiry,stock.unit,stock.item_description,stock_collection.tax_per,stock.stock_f_id,stock.current_stock FROM stock_collection LEFT JOIN stock ON stock_collection.product_id = stock.stock_f_id ;",
    (status, data) => {
      this.searchVal = JSON.parse(data).data;
      // addRowIfnotLastcolumnnotempty("myTable");
      console.log("serachval=>", this.searchVal);
    }
  );

  document
    .getElementsByTagName("body")[0]
    .addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        console.log("keypress called");
        addRowIfnotLastcolumnnotempty("myTable");
        event.preventDefault();
      }
    });
  //creating receipt object

  //when page is loaded one row is added
  function addRowIfnotLastcolumnnotempty(table_id) {
    var table = document.getElementById(table_id);
    console.log(
      "addRowIfnotLastcolumnnotempty ==> table row length vs reciept row length",
      table.rows.length - 2,
      mReceipt.getProducts().length
    );
    if (table.rows.length - 2 == mReceipt.getProducts().length) {
      CreateRow(table_id);
    }
  }
  //delete row function

  var sale_tbody = document.getElementById("tbdy");
  var numberofselectedrows = 0;
  var deleteIndex = [];
  var deletedRowId = [];
  function deleteRow() {
    numberofselectedrows = 0;
    document.getElementById("delete-row").style.display = "none";
    for (var i = 2; i < a.rows.length; i++) {
      if (a.rows[i].cells[0].firstChild.checked) {
        deleteIndex.push(i);
        console.log("delete row index=>", i);
        if (i < this.rowLength + 2 && clickdata_id[1] == "convert") {
          deletedRowId.push(a.rows[i].cells[1].firstChild.stockId);
          this.rowLength--;
        }
      }
    }
    for (var i = deleteIndex.length - 1; i > -1; i--) {
      a.rows[deleteIndex[i]].remove();
      mReceipt.deleteProduct(deleteIndex[i] - 2);
    }

    deleteIndex = [];
    gTotal.innerHTML = mReceipt.getGrandTotal();
    console.log("deleted values id=>", deletedRowId);
  }
  //function to create row

  function CreateRow(table_id) {
    var table = document.getElementById(table_id);
    var t_body = document.getElementById("tbdy");
    var row = t_body.insertRow(table.rows.length - 2);

    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    var cell6 = row.insertCell(5);
    var cell7 = row.insertCell(6);
    var cell8 = row.insertCell(7);
    var cell9 = row.insertCell(8);
    var cell10 = row.insertCell(9);
    var cell11 = row.insertCell(10);
    var cell12 = row.insertCell(11);

    cell1.append(createInputCheckbox("cell1"));
    cell2.append(createInputtext());
    cell3.append(createInputtext());
    cell4.append(createInputtextDisabled());
    cell5.append(createInputNumber());
    cell6.append(createInputtextDisabled());
    cell7.append(createInputNumber());
    cell8.append(createInputNumber());
    cell9.append(createInputNumber());
    cell10.append(createInputSelect());
    cell11.append(createInputNumber());
    cell12.append(createInputNumber());

    table.oninput = (event) => {
      updateProduct(event);
    };
    console.log("searchval value inside createrow=>", this.searchVal);

    inflateAutoCompleateView(
      table.rows[table.rows.length - 1].cells[1].firstChild,
      this.searchVal,
      table.rows.length,
      (product, rowIndex) => {
        rowIndex = rowIndex - 1;

        console.log("selected product ==> ", product, " ", rowIndex);
        var a = document.getElementById("myTable");
        var gTotal = document.getElementById("grandtotal");
        a.rows[rowIndex].cells[2].firstChild.disabled = false;
        a.rows[rowIndex].cells[3].firstChild.disabled = false;
        a.rows[rowIndex].cells[4].firstChild.disabled = false;
        a.rows[rowIndex].cells[5].firstChild.disabled = false;
        a.rows[rowIndex].cells[6].firstChild.disabled = false;
        a.rows[rowIndex].cells[7].firstChild.disabled = false;
        a.rows[rowIndex].cells[8].firstChild.disabled = false;
        a.rows[rowIndex].cells[9].firstChild.disabled = false;

        selectColumnFill(product, a, rowIndex);

        console.log("column filled");
        var p = new Product(
          [product[0]],
          product[1],
          product[6],
          product[2],
          product[3],
          product[8],
          product[7],
          product[4],
          product[5]
        );
        mReceipt.addproduct(p);

        console.log(
          "total amount when item is added=>",
          mReceipt.getProducts()[rowIndex - 2].getTotal()
        );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        a.rows[rowIndex].cells[4].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getQuantity();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
      }
    );
  }

  function createInputCheckbox(id) {
    var checkType = document.createElement("input");
    checkType.type = "checkbox";
    checkType.id = id;
    checkType.addEventListener("click", (event) => {
      if (event.target.checked) {
        numberofselectedrows++;
      } else {
        numberofselectedrows--;
      }
      if (numberofselectedrows > 0) {
        document.getElementById("delete-row").style.display = "inline-block";
      } else {
        document.getElementById("delete-row").style.display = "none";
      }
    });
    return checkType;
  }

  function createInputtext() {
    var textType = document.createElement("input");
    textType.type = "text";

    return textType;
  }
  function createInputtextDisabled() {
    var textType = document.createElement("input");
    textType.type = "text";
    textType.disabled = true;
    return textType;
  }
  function createInputNumber() {
    var numType = document.createElement("input");
    numType.type = "number";
    numType.min = "0";
    numType.disabled = true;

    return numType;
  }
  // function createImg(table, imgsrc) {
  //   var imgType = document.createElement("img");
  //   imgType.src = imgsrc;
  //   imgType.onclick = (event) => {
  //     console.log(
  //       "deleted the row ==> " + event.target.parentNode.parentNode.rowIndex
  //     );
  //     mReceipt.deleteProduct(event.target.parentNode.parentNode.rowIndex - 2);
  //     table.rows[event.target.parentNode.parentNode.rowIndex].remove();

  //     gTotal.innerHTML = mReceipt.getGrandTotal();
  //   };

  //   return imgType;
  // }
  function createInputSelect() {
    var SelectType = document.createElement("select");
    SelectType.disabled = true;
    var selectarray = [0, 5, 12, 18, 28];

    for (var i = 0; i < 5; i++) {
      var optionApp = document.createElement("option");
      optionApp.value = selectarray[i];
      optionApp.innerHTML = selectarray[i];
      SelectType.appendChild(optionApp);
    }
    return SelectType;
  }

  var gTotal = document.getElementById("grandtotal");
  function updateProduct(event) {
    let cell = event.target;
    var rowIndex = cell.parentNode.parentNode.rowIndex;
    var cellIndex = cell.parentNode.cellIndex;

    switch (cellIndex) {
      case 2:
        mReceipt
          .getProducts()
          [rowIndex - 2].setbatch(a.rows[rowIndex].cells[2].firstChild.value);
        break;
      case 3:
        mReceipt
          .getProducts()
          [rowIndex - 2].setExpiry(a.rows[rowIndex].cells[3].firstChild.value);
        break;
      case 4:
        mReceipt
          .getProducts()
          [rowIndex - 2].setQuantity(
            a.rows[rowIndex].cells[4].firstChild.value
          );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 5:
        mReceipt
          .getProducts()
          [rowIndex - 2].setUnit(a.rows[rowIndex].cells[5].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 6:
        mReceipt
          .getProducts()
          [rowIndex - 2].setPrice(a.rows[rowIndex].cells[6].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 7:
        mReceipt
          .getProducts()
          [rowIndex - 2].setDiscount(
            a.rows[rowIndex].cells[7].firstChild.value
          );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 8:
        console.log(
          "discount amount changed",
          (a.rows[rowIndex].cells[8].firstChild.value /
            mReceipt.getProducts()[rowIndex - 2].getTotalPrice()) *
            100
        );
        a.rows[rowIndex].cells[7].firstChild.value =
          Math.round(
            (a.rows[rowIndex].cells[8].firstChild.value /
              mReceipt.getProducts()[rowIndex - 2].getTotalPrice()) *
              100 *
              1e2
          ) / 1e2;

        mReceipt
          .getProducts()
          [rowIndex - 2].setDiscount(
            a.rows[rowIndex].cells[7].firstChild.value
          );
        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();

        break;
      case 9:
        mReceipt
          .getProducts()
          [rowIndex - 2].setTax(a.rows[rowIndex].cells[9].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
    }
  }

  function selectColumnFill(product, a, rowIndex) {
    //batch_no
    (a.rows[rowIndex].cells[2].firstChild.value = product[4]),
      //expiry_date
      (a.rows[rowIndex].cells[3].firstChild.value = product[5]),
      //unit
      (a.rows[rowIndex].cells[5].firstChild.value = product[6]),
      //price
      (a.rows[rowIndex].cells[6].firstChild.value = product[2]),
      //discount
      (a.rows[rowIndex].cells[7].firstChild.value = product[3]);
  }

  //============================================
  function currentDate(datId) {
    datId.valueAsDate = new Date();
  }
  // currentDate(document.getElementById("pbdate"));

  function getDiscount() {
    mReceipt.setDiscount(document.getElementById("granddisc").value);
    gTotal.innerHTML = mReceipt.getGrandTotal();
  }

  document
    .getElementById("save-submit-button")
    .addEventListener("click", console.log("save event called"));
  document.getElementsByClassName("button-div")[0].style.width = "34%";
  function purchaseOrderUpdate() {
    // var reciept_n = document.getElementById("pon").value;
    var table_data = document.getElementById("myTable");

    var pb_dat = document.getElementById("pbdate").value;
    var pay_method_po = document.getElementById("payment-select").value;
    var party_id = document.getElementById("partydt").selectedItemId;
    var desp = document.getElementById("desp").value;
    var disc = document.getElementById("granddisc").value;
    var poNum = document.getElementById("pBnumber").value;
    var value;
    mReceipt.setReceipt(poNum);
    mReceipt.setDate(pb_dat);
    var po_sql_query =
      "UPDATE purchase_bill SET bill_pay_method=" +
      "'" +
      pay_method_po +
      "'" +
      "," +
      "bill_discount=" +
      "'" +
      disc +
      "'" +
      "," +
      "bill_description=" +
      "'" +
      desp +
      "'" +
      "," +
      "total_amnt=" +
      "'" +
      mReceipt.getGrandTotal() +
      "'" +
      " " +
      "WHERE purchase_bill.bill_id=" +
      poNum +
      ";";
    console.log("streampurchaseorderquery=>", po_sql_query);
    window.MainDatastream.streamAddData(po_sql_query, value, (status, data) => {
      console.log("streampurchaseorder=>", status, JSON.parse(data));
    });
    var data_value = mReceipt.getProducts();
    console.log(
      "data_value",
      typeof data_value,
      data_value,
      data_value[0].getId()
    );
    for (var i = 0; i < this.rowLength; i++) {
      var update_querry =
        "UPDATE purchase_bill_list SET list_price=" +
        "'" +
        data_value[i].getPrice() +
        "'" +
        "," +
        "list_unit=" +
        "'" +
        data_value[i].getUnit() +
        "'" +
        "," +
        "list_tax=" +
        "'" +
        data_value[i].getTax() +
        "'" +
        "," +
        "list_amount=" +
        "'" +
        data_value[i].getTotal() +
        "'" +
        "," +
        "list_quantity=" +
        "'" +
        data_value[i].getQuantity() +
        "'" +
        "," +
        "exp_dat=" +
        "'" +
        data_value[i].getexpiry() +
        "'" +
        "," +
        "list_discount=" +
        "'" +
        data_value[i].getDiscount() +
        "'" +
        "," +
        "list_batch=" +
        "'" +
        data_value[i].getbatch_no() +
        "'" +
        " " +
        "WHERE purchase_bill_list.list_id=" +
        data_value[i].getId()[1] +
        ";";
      console.log("streampurchaseorderlistquery=>", update_querry);
      window.MainDatastream.streamAddData(
        update_querry,
        value,
        (status, data) => {
          console.log(
            "streampurchaseorderlistdata=>",
            status,
            JSON.parse(data)
          );
        }
      );
    }

    var purListIns = "";
    for (var i = this.rowLength; i < data_value.length; i++) {
      purListIns +=
        "('" +
        mReceipt.getReceipt() +
        "','" +
        data_value[i].getName() +
        "','" +
        data_value[i].getUnit() +
        "','" +
        data_value[i].getId()[0] +
        "','" +
        data_value[i].getPrice() +
        "','" +
        data_value[i].getQuantity() +
        "','" +
        data_value[i].getDiscount() +
        "','" +
        data_value[i].getTax() +
        "','" +
        data_value[i].getTotal() +
        "','" +
        data_value[i].getexpiry() +
        "','" +
        data_value[i].getbatch_no() +
        "')";
      if (i < data_value.length - 1) {
        purListIns += ",";
      }
    }
    console.log("streaminsertpurchaseordervalue=>", purListIns);

    window.MainDatastream.streamAddData(
      "INSERT INTO purchase_bill_list(pur_bill_f_key ,list_stockname,list_unit,stock_f_key,list_price,list_quantity,list_discount,list_tax,list_amount,exp_dat,list_batch)",
      purListIns,
      (status, data) => {
        console.log("addstock", status, data);
      }
    );
    if (deletedRowId.length !== 0) {
      console.log("deletequery called", deletedRowId);
      for (var i = 0; i < deletedRowId.length; i++)
        var sqlUpdateQuery =
          "UPDATE purchase_bill_list SET is_deleted='1' WHERE list_id=" +
          deletedRowId[i] +
          ";";
      console.log("deletequery called", deletedRowId, sqlUpdateQuery);

      window.MainDatastream.streamAddData(
        sqlUpdateQuery,
        value,
        (status, data) => {}
      );
    }
    SnackboxAlert("snackbar");
  }
</script>
