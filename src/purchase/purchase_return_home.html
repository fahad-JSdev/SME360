<link rel="stylesheet" href="../assets/themes/purchase_return_home.css" />
<div class="container">
  <div class="container1" id="container1">
    <div id="tabwrap"></div>

    <div id="header"></div>
  </div>
  <!-- <div class="table1-div">
    <br />
    <span id="elements2">Transactions</span>
    <button id="add-purchase-order" onclick="openPR()">
      <img
        src="../assets/message-square-add-regular-24.png"
        class="print_button"
      /><span>Add Debit Note</span>
    </button>
  </div> -->
  <div id="wrapper1" class="ag-theme-alpine"></div>
</div>

<script>
  function setDime(w, h) {
    if (w != undefined) {
      $("#wrapper1").css("width", (w * 96.2) / 100);
      $("#wrapper1").css("height", (h * 95.2) / 100);
      //   $(".container2").css("height", (h * 85) / 100);
      //   $("#site-grid-side").css("height", (h * 85) / 100);
      //   $("#wrapper3").css("width", (w * 96.5) / 100);
      //   $("#wrapper3").css("height", (h * 86) / 100);
      // } else console.log("dime not defined");
    }
  }

  try {
    setDime(window.screen.availWidth, window.screen.availHeight);
  } catch (err) {
    console.log("-dime not defined");
  }
  Purchasereturnactionbar = new Actionbar();

  Purchasereturnactionbar.addIcon(
    "add_return",
    "../assets/images/add-expense.png",
    "Add Return"
  );
  Purchasereturnactionbar.addIcon(
    "print_button",
    "../assets/images/toolbar-print.png",
    "Print"
  );
  Purchasereturnactionbar.addIcon(
    "export_button",
    ".././assets/images/export_excel-img.png",
    "export"
  );
  Purchasereturnactionbar.addIcon(
    "edit_button",
    ".././assets/images/editing.png",
    "Edit"
  );
  Purchasereturnactionbar.addIcon(
    "delete_button",
    ".././assets/images/delete.png",
    "Delete"
  );

  function handler(event) {
    switch (event.target.id) {
      case "add_return":
        nReturn();
        break;
      case "edit_button":
        btnClickedHandleEdit();
        break;
      case "delete_button":
        btnClickedHandlerDelete();
        break;
    }
  }
  Purchasereturnactionbar.render(document.getElementById("header"));
  Purchasereturnactionbar.setToolbarOnClick(handler);
  document.getElementById("print_button").style.display = "none";
  document.getElementById("edit_button").style.display = "none";
  document.getElementById("delete_button").style.display = "none";

  var Purchasereturntabbar;
  if (Purchasereturntabbar == undefined) {
    Purchasereturntabbar = new Tabbar();
    Purchasereturntabbar.addTab("purchse_head", "Purchase return");
  }
  Purchasereturntabbar.render(document.getElementById("tabwrap"));
  //============================================================
  function btnClickedHandleEdit() {
    const selectedRows = gridOptions6.api.getSelectedRows();
    if (selectedRows.length == 1) {
      window.open(
        "./purchase_return_edit.html?data=" +
          encodeURIComponent(
            JSON.stringify([
              selectedRows[0][1],
              selectedRows[0][0],
              selectedRows[0][2],
              "edit",
            ])
          ),
        "-blank",
        "resizable=0,frame=0," +
          "width=" +
          getWidth() +
          ",height=" +
          getHeight()
      );
      console.log("purchase home val=>", selectedRows[0]);
    }
  }
  function btnClickedHandlerDelete(event) {
    //   var clickdata_id1;
    //   this.params.clicked(this.params.value);
    //   clickdata_id1 = this.params.data[1];
    //   var sqlQuery =
    //     "UPDATE purchase_order SET is_deleted='1' WHERE purchase_order.order_id=" +
    //     clickdata_id1 +
    //     ";";
    //   var value;
    //   window.MainDatastream.streamAddData(
    //     sqlQuery,
    //     value,
    //     (status, data) => {}
    //   );
    //   SnackboxAlert("snackbar");
    // }
    // destroy() {
    //   this.eGui.removeEventListener("click", this.btnClickedHandler);
  }
  // DATA GENERATION
  var _randNum1 = (size) => Math.random() * size;
  var _zeroPad1 = (num) => (num < 10 ? "0" + num : num);

  var _generateDate = () => {
    var day = Math.round(_randNum(27)) + 1;
    var month = Math.round(_randNum(11)) + 1;
    var year = Math.round(_randNum(70)) + 1950;
    return `${_zeroPad(day)}/${_zeroPad(month)}/${year}`;
  };

  function createRowData(maxRows) {
    let rowData = [];
    for (var i = 0; i < maxRows; i++) {
      var row = {
        date: _generateDate(),
      };
      rowData.push(row);
    }
    return rowData;
  }

  // DATE COMPARATOR FOR SORTING
  // function dateComparator(date1, date2) {
  //   var date1Number = _monthToNum(date1);
  //   var date2Number = _monthToNum(date2);

  //   if (date1Number === null && date2Number === null) {
  //     return 0;
  //   }
  //   if (date1Number === null) {
  //     return -1;
  //   }
  //   if (date2Number === null) {
  //     return 1;
  //   }

  //   return date1Number - date2Number;
  // }

  // HELPER FOR DATE COMPARISON
  function _monthToNum(date) {
    if (date === undefined || date === null || date.length !== 10) {
      return null;
    }

    var yearNumber = date.substring(6, 10);
    var monthNumber = date.substring(3, 5);
    var dayNumber = date.substring(0, 2);

    var result = yearNumber * 10000 + monthNumber * 100 + dayNumber;
    // 29/08/2004 => 20040829
    return result;
  }

  // DATA FORMATTING
  // function dateFormatter(params) {
  //   var dateAsString = params.data.date;
  //   var dateParts = dateAsString.split("/");
  //   return `${dateParts[0]} - ${dateParts[1]} - ${dateParts[2]}`;
  // }
  // var rBtnRenderer;
  // if (typeof rBtnRenderer !== "function") {
  //   rBtnRenderer = class {
  //     init(params) {
  //       this.params = params;
  //       this.eGui = document.createElement("div");
  //       this.eGui.classList.add("custom-element");
  //       this.button1 = document.createElement("img");
  //       this.button2 = document.createElement("img");
  //       this.button3 = document.createElement("img");

  //       this.button1.id = "edit_Button";
  //       this.button2.id = "Reject_Button";

  //       this.button1.src = ".././assets/images/edit-eye.png";
  //       this.button2.src = ".././assets/images/trash-icon.png";

  //       this.btnClickedHandleEdit = this.btnClickedHandleEdit.bind(this);
  //       this.btnClickedHandlerDelete = this.btnClickedHandlerDelete.bind(this);
  //       this.button1.addEventListener("click", this.btnClickedHandleEdit);
  //       this.button2.addEventListener("click", this.btnClickedHandlerDelete);

  //       this.eGui.appendChild(this.button1);
  //       this.eGui.appendChild(this.button2);
  //     }

  //     getGui() {
  //       return this.eGui;
  //     }

  //     btnClickedHandleEdit(event) {
  //       this.params.clicked(this.params.value);
  //       window.open(
  //         "./purchase_return_edit.html?data=" +
  //           encodeURIComponent(
  //             JSON.stringify([
  //               this.params.data[1],
  //               this.params.data[0],
  //               this.params.data[2],
  //               "edit",
  //             ])
  //           ),
  //         "-blank",
  //         "resizable=0,frame=0," +
  //           "width=" +
  //           getWidth() +
  //           ",height=" +
  //           getHeight()
  //       );
  //       console.log("purchase home val=>", this.params.data[1]);
  //     }
  //     btnClickedHandlerDelete(event) {
  //       //   var clickdata_id1;
  //       //   this.params.clicked(this.params.value);
  //       //   clickdata_id1 = this.params.data[1];
  //       //   var sqlQuery =
  //       //     "UPDATE purchase_order SET is_deleted='1' WHERE purchase_order.order_id=" +
  //       //     clickdata_id1 +
  //       //     ";";
  //       //   var value;
  //       //   window.MainDatastream.streamAddData(
  //       //     sqlQuery,
  //       //     value,
  //       //     (status, data) => {}
  //       //   );
  //       //   SnackboxAlert("snackbar");
  //       // }
  //       // destroy() {
  //       //   this.eGui.removeEventListener("click", this.btnClickedHandler);
  //     }
  //   };
  // }

  var gridOptions6 = {
    columnDefs: [
      {
        headerName: "SLN",
        valueGetter: "node.rowIndex + 1",
        resizable: true,
      },
      { headerName: "No. ", field: "0", resizable: true },
      { headerName: "id", field: "1", hide: true },
      {
        headerName: "Date ",
        field: "2",
        resizable: true,
        // valueFormatter: dateFormatter,
        comparator: dateComparator,
        filter: "agDateColumnFilter",
        floatingFilter: true,
        floatingFilterComponentParams: {
          suppressFilterButton: true,
        },
        filterParams: {
          debounceMs: 500,
          suppressAndOrCondition: true,
          comparator: function (filterLocalDateAtMidnight, cellValue) {
            if (cellValue == null) {
              return 0;
            }
            var dateParts = cellValue.split("/");
            var year = Number(dateParts[2]);
            var month = Number(dateParts[1]) - 1;
            var day = Number(dateParts[0]);
            var cellDate = new Date(year, month, day);

            if (cellDate < filterLocalDateAtMidnight) {
              return -1;
            } else if (cellDate > filterLocalDateAtMidnight) {
              return 1;
            } else {
              return 0;
            }
          },
        },
      },
      { headerName: "Party", field: "3", resizable: true },

      {
        headerName: "Total Amount",
        field: "4",
        resizable: true,
        floatingFilter: true,
      },
      // {
      //   headerName: "Action",
      //   field: "5",
      //   resizable: true,
      //   cellRenderer: rBtnRenderer,
      //   floatingFilter: true,
      //   floatingFilterComponentParams: {
      //     suppressFilterButton: true,
      //   },

      //   cellRendererParams: {
      //     clicked: function (field) {},
      //   },
      // },
    ],
    // getSelectedRows: 'getSelectedRows',
    // cellClicked:'onCellClicked',
    // onSelectionChanged: 'onSelectionChanged',
    onRowSelected: onRowSelected,
    onRowDoubleClicked: openpurchaseorder,
    onFirstDataRendered: onFirstDataRendered,
    defaultColDef: {
      sortable: true,
      flex: 1,
      // floatingFilter: true,
    },
    pagination: true,
    paginationPageSize: 10,
    rowSelection: "multiple",
    animateRows: true,
  };
  function onRowSelected() {
    const selectedRows = gridOptions6.api.getSelectedRows();
    if (selectedRows) {
      console.log(" row selected");
      document.getElementById("delete_button").style.display = "flex";
      document.getElementById("export_button").style.display = "flex";
      // document.getElementById("import_button").style.display = "flex";
      document.getElementById("print_button").style.display = "flex";
      document.getElementById("edit_button").style.display = "flex";

      if (selectedRows.length > 1) {
        console.log("more than one row selected function called");
        document.getElementById("export_button").style.display = "none";
        // document.getElementById("import_button").style.display = "none";
        document.getElementById("print_button").style.display = "none";
        document.getElementById("edit_button").style.display = "none";
        // document.getElementById("convert_button").style.display = "none";
      }
    }
  }
  function openpurchaseorder(event) {
    window.open(
      "./purchase_return_edit.html?data=" +
        encodeURIComponent(
          JSON.stringify([
            event.node.data[1],
            event.node.data[0],
            event.node.data[2],
            "editing",
          ])
        ),
      "-blank",
      "resizable=0,frame=0," + "width=" + getWidth() + ",height=" + getHeight()
    );
  }

  var GridDiv6 = document.getElementById("wrapper1");
  new agGrid.Grid(GridDiv6, gridOptions6);

  window.MainDatastream.streamGetData(
    "SELECT purchase_return.return_id,purchase_return.pur_bill_fid,purchase_return.return_dat,vendor.vendor_name,purchase_bill.total_amnt FROM purchase_return LEFT JOIN vendor ON (select vendor_f_id FROM purchase_bill WHERE purchase_return.pur_bill_fid = purchase_bill.bill_id) = vendor.personid LEFT JOIN purchase_bill ON purchase_return.pur_bill_fid = purchase_bill.bill_id ;",
    (status, data) => {
      gridOptions6.api.setRowData(JSON.parse(data).data);
    }
  );

  window.electronAPI.setTitle("PURCHASE RETURN");

  function onFilterTextBoxChanged() {
    gridOptions6.api.setQuickFilter(
      document.getElementById("filter-text-box").value
    );
  }

  var inp = document.createElement("input");
  var root = document.getElementsByClassName("ag-header-row-column-filter");
  inp.id = "filter-text-box";
  inp.type = "text";
  inp.placeholder = "Type a keyword..";
  inp.oninput = function () {
    onFilterTextBoxChanged();
  };
  root[0].appendChild(inp);
</script>
