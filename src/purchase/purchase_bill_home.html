<style></style>
<link rel="stylesheet" href="../assets/themes/purchase_bill_home.css" />
<div class="container">
  <div class="container1" id="container1">
    <div id="tabwrap"></div>

    <div id="header"></div>
  </div>

  <!-- <div class="table1-div">
    <br />
    <span id="elements2">Transactions</span>
    <button type="button" id="add-purchase-bill" onclick="openPbill()">
      <span>Add Purchase Bill</span>
    </button>
  </div> -->
  <div id="wrapper1" class="ag-theme-alpine">
    <div id="snackbar" class="snackbar">Deleted</div>
  </div>
</div>

<script>
  function setDime(w, h) {
    if (w != undefined) {
      $("#wrapper1").css("width", (w * 96.3) / 100);
      $("#wrapper1").css("height", (h * 87.2) / 100);
      //   $(".container2").css("height", (h * 85) / 100);
      //   $("#site-grid-side").css("height", (h * 85) / 100);
      //   $("#wrapper3").css("width", (w * 96.5) / 100);
      //   $("#wrapper3").css("height", (h * 86) / 100);
      // } else console.log("dime not defined");
    }
  }

  try {
    setDime(window.screen.availWidth, window.screen.availHeight);
  } catch (err) {
    console.log("-dime not defined");
  }

  SnackboxAlertStyle();
  purchasebillactionbar = new Actionbar();

  purchasebillactionbar.addIcon(
    "add_purchase",
    "../assets/images/add-expense.png",
    "Add Purchase"
  );
  purchasebillactionbar.addIcon(
    "export_button",
    ".././assets/images/export_excel-img.png",
    "Export"
  );
  purchasebillactionbar.addIcon(
    "import_button",
    ".././assets/images/import.png",
    "Import"
  );
  purchasebillactionbar.addIcon(
    "print_button",
    "../assets/images/toolbar-print.png",
    "Print"
  );
  purchasebillactionbar.addIcon(
    "edit_button",
    ".././assets/images/editing.png",
    "Edit"
  );
  purchasebillactionbar.addIcon(
    "convert_button",
    ".././assets/images/convert.png",
    "Convert"
  );
  purchasebillactionbar.addIcon(
    "delete_button",
    ".././assets/images/delete.png",
    "Delete"
  );
  function handler(event) {
    switch (event.target.id) {
      case "add_purchase":
        nPurchase();
        break;
      case "export_button":
        download();
        break;
      case "import_button":
        break;
      case "print_button":
        btnClickedHandlerPrint();
        break;
      case "convert_button":
        btnClickedHandlerReturn();
        break;
      case "edit_button":
        btnClickedHandleEdit();
        break;
      case "delete_button":
        btnClickedHandlerDelete();
        break;
    }
  }
  purchasebillactionbar.render(document.getElementById("header"));
  purchasebillactionbar.setToolbarOnClick(handler);
  document.getElementById("export_button").style.display = "none";
  document.getElementById("print_button").style.display = "none";
  document.getElementById("edit_button").style.display = "none";
  document.getElementById("delete_button").style.display = "none";
  document.getElementById("convert_button").style.display = "none";
  var purchasebilltabbar;
  if (purchasebilltabbar == undefined) {
    purchasebilltabbar = new Tabbar();
    purchasebilltabbar.addTab("purchse_head", "Transactions");
  }
  purchasebilltabbar.render(document.getElementById("tabwrap"));
  //==============================================================
  function btnClickedHandlerDelete() {
    const selectedRows = gridOptions4.api.getSelectedRows();
    console.log("row selected on ag grid", selectedRows[0]);
    if (selectedRows.length) {
      for (var i = 0; i < selectedRows.length; i++) {
        var sqlQuery =
          "UPDATE purchase_bill SET is_deleted='1' WHERE purchase_bill.bill_id=" +
          selectedRows[i][0] +
          ";";
        console.log("delete query", sqlQuery);
        var value;
        window.MainDatastream.streamAddData(
          sqlQuery,
          value,
          (status, data) => {}
        );
      }
      SnackboxAlert("snackbar");
    }
  }
  function btnClickedHandlerPrint() {
    const selectedRows = gridOptions4.api.getSelectedRows();
    if (selectedRows.length == 1) {
      window.MainDatastream.streamGetDataOnce(
        "SELECT purchase_bill.bill_id,purchase_bill.pb_dat,purchase_bill.due_dat,purchase_bill.total_amnt,purchase_bill.bill_discount,purchase_bill.bill_pay_method,purchase_bill.bill_description,pur_bill_list.list_stockname,pur_bill_list.list_batch,pur_bill_list.exp_dat,pur_bill_list.list_quantity,pur_bill_list.list_unit,pur_bill_list.list_price,pur_bill_list.list_tax,pur_bill_list.list_amount,vendor.vendor_name,vendor.gst_in ,vendor.phone_no ,vendor.email_id ,vendor.state ,vendor.billing_address,pur_bill_list.list_discount,stock.item_description,stock.stock_id,pur_bill_list.list_id FROM purchase_bill LEFT JOIN vendor ON purchase_bill.vendor_f_id = vendor.personid LEFT JOIN purchase_bill_list AS pur_bill_list ON purchase_bill.bill_id = pur_bill_list.pur_bill_f_key LEFT JOIN stock ON pur_bill_list.stock_f_key = stock.stock_id WHERE purchase_bill.bill_id=" +
          selectedRows[0][0] +
          ";",
        (status, data) => {
          console.log("datada from database=>", JSON.parse(data).data);
          var args = {
            gstno: "werty1111111111111111",
            company: "POWERTA",
            phone: JSON.parse(data).data[0][17],
            email: JSON.parse(data).data[0][18],
            vendor: JSON.parse(data).data[0][15],
            vendorgst: JSON.parse(data).data[0][16],
            billno: JSON.parse(data).data[0][0],
            billdate: JSON.parse(data).data[0][1],
            pay_method: JSON.parse(data).data[0][5],
            totaldisc: JSON.parse(data).data[0][4],
            grandtotal: JSON.parse(data).data[0][3],
            desp: JSON.parse(data).data[0][6],
            items: "",
          };
          var items = [];
          for (var i = 0; i < JSON.parse(data).data.length; i++) {
            items.push({
              itemname: JSON.parse(data).data[i][7],
              batch: JSON.parse(data).data[i][8],
              exp: JSON.parse(data).data[i][9],
              quantity: JSON.parse(data).data[i][10],
              unit: JSON.parse(data).data[i][11],
              price: JSON.parse(data).data[i][12],
              discount: JSON.parse(data).data[i][21],
              tax: JSON.parse(data).data[i][13],
              amount: JSON.parse(data).data[i][14],
            });
          }
          args.items = items;

          console.log("arg value is defined as=>", args);
          window.electronAPI.generatePdf(args, "./jstemplate/report.html");
        }
      );
      var res = {
        gstno: "123333",
        company: "123333",
        landphone: "123333",
        mobnum: "123333",
        email: "123333",
        vendor: "123333",
        vendorgst: "123333",
        vendorpan: "123333",
        billno: "123333",
        billdate: "123333",
        total: "123333",
        tcs: "123333",
        totaldisc: "123333",
        roundamnt: "123333",
        grandtotal: "123333",
        items: [
          {
            itemname: 123333,
            batch: 123333,
            exp: 123333,
            quantity: 123333,
            unit: 123333,
            price: 123333,
            discount: 123333,
            tax: 123333,
            amount: 123333,
          },
          {
            itemname: "123333",
            batch: "123333",
            exp: "123333",
            quantity: "123333",
            unit: "123333",
            price: "123333",
            discount: "123333",
            tax: "123333",
            amount: "123333",
          },
          {
            itemname: "123333",
            batch: "123333",
            exp: "123333",
            quantity: "123333",
            unit: "123333",
            price: "123333",
            discount: "123333",
            tax: "123333",
            amount: "123333",
          },
        ],
      };
      console.log("res value is defined as=>", res);

      window.electronAPI.handleCounter((ev, data) => {});
    }
  }
  function btnClickedHandlerReturn() {
    const selectedRows = gridOptions4.api.getSelectedRows();
    if (selectedRows.length == 1) {
      var w = window.open(
        "./purchase_return.html?data=" +
          encodeURIComponent(JSON.stringify([selectedRows[0][0], "return"])),
        "-blank",
        "resizable=0,frame=0," +
          "width=" +
          getWidth() +
          ",height=" +
          getHeight()
      );
    }
  }
  function btnClickedHandleEdit() {
    const selectedRows = gridOptions4.api.getSelectedRows();
    if (selectedRows.length == 1) {
      window.open(
        "./purchase_bill_edit.html?data=" +
          encodeURIComponent(JSON.stringify([selectedRows[0][0], "billedit"])),
        "-blank",
        "resizable=0,frame=0," +
          "width=" +
          getWidth() +
          ",height=" +
          getHeight()
      );
      console.log("purchase home val=>", selectedRows[0]);
    }
  }
  function btnClickedHandleEditing(event) {
    window.open(
      "./purchase_bill_edit.html?data=" +
        encodeURIComponent(JSON.stringify([event.node.data[0], "billediting"])),
      "-blank",
      "resizable=0,frame=0," + "width=" + getWidth() + ",height=" + getHeight()
    );
    console.log("purchase home val=>", selectedRows[0]);
  }

  // DATA GENERATION
  var _randNum = (size) => Math.random() * size;
  var _zeroPad = (num) => (num < 10 ? "0" + num : num);

  // var _generateDate = () => {
  //   var day = Math.round(_randNum(27)) + 1;
  //   var month = Math.round(_randNum(11)) + 1;
  //   var year = Math.round(_randNum(70)) + 1950;
  //   return `${_zeroPad(day)}/${_zeroPad(month)}/${year}`;
  // };

  function createRowData(maxRows) {
    let rowData = [];
    for (var i = 0; i < maxRows; i++) {
      var row = {
        date: _generateDate(),
      };
      rowData.push(row);
    }
    return rowData;
  }

  // HELPER FOR DATE COMPARISON
  function _monthToNum(date) {
    if (date === undefined || date === null || date.length !== 10) {
      return null;
    }

    var yearNumber = date.substring(6, 10);
    var monthNumber = date.substring(3, 5);
    var dayNumber = date.substring(0, 2);

    var result = yearNumber * 10000 + monthNumber * 100 + dayNumber;
    // 29/08/2004 => 20040829
    return result;
  }

  // DATA FORMATTING
  // function dateFormatter(params) {
  //   var dateAsString = params.data.date;
  //   var dateParts = dateAsString.split("/");
  //   return `${dateParts[0]} - ${dateParts[1]} - ${dateParts[2]}`;
  // }

  // var BtnCellRenderer;
  // if (typeof BtnCellRenderer !== "function") {
  //   BtnCellRenderer = class {
  //     init(params) {
  //       this.params = params;
  //       this.eGui = document.createElement("div");
  //       this.eGui.classList.add("custom-element");
  //       this.button1 = document.createElement("img");
  //       this.button2 = document.createElement("img");
  //       this.button3 = document.createElement("img");
  //       this.button4 = document.createElement("img");

  //       this.button1.id = "purchase_return";
  //       this.button2.id = "Reject_Button";
  //       this.button3.id = "edit_Button";
  //       this.button4.id = "print_Button";

  //       this.button1.src = ".././assets/images/approve-tick.png";
  //       this.button2.src = ".././assets/images/trash-icon.png";
  //       this.button3.src = ".././assets/images/edit-eye.png";
  //       this.button4.src = ".././assets/images/print-new.png";
  //       this.btnClickedHandlerReturn = this.btnClickedHandlerReturn.bind(this);
  //       this.btnClickedHandleEdit = this.btnClickedHandleEdit.bind(this);
  //       this.btnClickedHandlerDelete = this.btnClickedHandlerDelete.bind(this);
  //       this.btnClickedHandlerPrint = this.btnClickedHandlerPrint.bind(this);
  //       this.button1.addEventListener("click", this.btnClickedHandlerReturn);
  //       this.button2.addEventListener("click", this.btnClickedHandlerDelete);
  //       this.button4.addEventListener("click", this.btnClickedHandlerPrint);
  //       this.button3.addEventListener("click", this.btnClickedHandleEdit);

  //       this.eGui.appendChild(this.button3);
  //       this.eGui.appendChild(this.button1);
  //       this.eGui.appendChild(this.button2);
  //       this.eGui.appendChild(this.button4);
  //     }

  //     getGui() {
  //       return this.eGui;
  //     }
  //     btnClickedHandlerPrint(event) {
  //       this.params.clicked(this.params.value);
  //       window.MainDatastream.streamGetDataOnce(
  //         "SELECT purchase_bill.bill_id,purchase_bill.pb_dat,purchase_bill.due_dat,purchase_bill.total_amnt,purchase_bill.bill_discount,purchase_bill.bill_pay_method,purchase_bill.bill_description,pur_bill_list.list_stockname,pur_bill_list.list_batch,pur_bill_list.exp_dat,pur_bill_list.list_quantity,pur_bill_list.list_unit,pur_bill_list.list_price,pur_bill_list.list_tax,pur_bill_list.list_amount,vendor.vendor_name,vendor.gst_in ,vendor.phone_no ,vendor.email_id ,vendor.state ,vendor.billing_address,pur_bill_list.list_discount,stock.item_description,stock.stock_id,pur_bill_list.list_id FROM purchase_bill LEFT JOIN vendor ON purchase_bill.vendor_f_id = vendor.personid LEFT JOIN purchase_bill_list AS pur_bill_list ON purchase_bill.bill_id = pur_bill_list.pur_bill_f_key LEFT JOIN stock ON pur_bill_list.stock_f_key = stock.stock_id WHERE purchase_bill.bill_id=" +
  //           this.params.data[0] +
  //           ";",
  //         (status, data) => {
  //           console.log("datada from database=>", JSON.parse(data).data);
  //           var args = {
  //             gstno: "werty1111111111111111",
  //             company: "POWERTA",
  //             phone: JSON.parse(data).data[0][17],
  //             email: JSON.parse(data).data[0][18],
  //             vendor: JSON.parse(data).data[0][15],
  //             vendorgst: JSON.parse(data).data[0][16],
  //             billno: JSON.parse(data).data[0][0],
  //             billdate: JSON.parse(data).data[0][1],
  //             pay_method: JSON.parse(data).data[0][5],
  //             totaldisc: JSON.parse(data).data[0][4],
  //             grandtotal: JSON.parse(data).data[0][3],
  //             desp: JSON.parse(data).data[0][6],
  //             items: "",
  //           };
  //           var items = [];
  //           for (var i = 0; i < JSON.parse(data).data.length; i++) {
  //             items.push({
  //               itemname: JSON.parse(data).data[i][7],
  //               batch: JSON.parse(data).data[i][8],
  //               exp: JSON.parse(data).data[i][9],
  //               quantity: JSON.parse(data).data[i][10],
  //               unit: JSON.parse(data).data[i][11],
  //               price: JSON.parse(data).data[i][12],
  //               discount: JSON.parse(data).data[i][21],
  //               tax: JSON.parse(data).data[i][13],
  //               amount: JSON.parse(data).data[i][14],
  //             });
  //           }
  //           args.items = items;

  //           console.log("arg value is defined as=>", args);
  //           window.electronAPI.generatePdf(args, "./jstemplate/report.html");
  //         }
  //       );
  //       var res = {
  //         gstno: "123333",
  //         company: "123333",
  //         landphone: "123333",
  //         mobnum: "123333",
  //         email: "123333",
  //         vendor: "123333",
  //         vendorgst: "123333",
  //         vendorpan: "123333",
  //         billno: "123333",
  //         billdate: "123333",
  //         total: "123333",
  //         tcs: "123333",
  //         totaldisc: "123333",
  //         roundamnt: "123333",
  //         grandtotal: "123333",
  //         items: [
  //           {
  //             itemname: 123333,
  //             batch: 123333,
  //             exp: 123333,
  //             quantity: 123333,
  //             unit: 123333,
  //             price: 123333,
  //             discount: 123333,
  //             tax: 123333,
  //             amount: 123333,
  //           },
  //           {
  //             itemname: "123333",
  //             batch: "123333",
  //             exp: "123333",
  //             quantity: "123333",
  //             unit: "123333",
  //             price: "123333",
  //             discount: "123333",
  //             tax: "123333",
  //             amount: "123333",
  //           },
  //           {
  //             itemname: "123333",
  //             batch: "123333",
  //             exp: "123333",
  //             quantity: "123333",
  //             unit: "123333",
  //             price: "123333",
  //             discount: "123333",
  //             tax: "123333",
  //             amount: "123333",
  //           },
  //         ],
  //       };
  //       console.log("res value is defined as=>", res);

  //       window.electronAPI.handleCounter((ev, data) => {});
  //     }
  //     btnClickedHandlerReturn(event) {
  //       this.params.clicked(this.params.value);

  //       var w = window.open(
  //         "./purchase_return.html?data=" +
  //           encodeURIComponent(JSON.stringify([this.params.data[0], "return"])),
  //         "-blank",
  //         "resizable=0,frame=0," +
  //           "width=" +
  //           getWidth() +
  //           ",height=" +
  //           getHeight()
  //       );
  //       console.log("purchase home val=>", this.params.data[1]);
  //     }
  //     btnClickedHandleEdit(event) {
  //       this.params.clicked(this.params.value);
  //       console.log("function called", this.params.data[0]);
  //       window.open(
  //         "./purchase_bill_edit.html?data=" +
  //           encodeURIComponent(
  //             JSON.stringify([this.params.data[0], "billedit"])
  //           ),
  //         "-blank",
  //         "resizable=0,frame=0," +
  //           "width=" +
  //           getWidth() +
  //           ",height=" +
  //           getHeight()
  //       );
  //       console.log("purchase home val=>", this.params.data[1]);
  //     }
  //     btnClickedHandlerDelete(event) {
  //       var clickdata_id1;
  //       this.params.clicked(this.params.value);
  //       clickdata_id1 = this.params.data[0];
  //       var sqlQuery =
  //         "UPDATE purchase_bill SET is_deleted='1' WHERE purchase_bill.bill_id=" +
  //         clickdata_id1 +
  //         ";";
  //       console.log("delete query", sqlQuery);
  //       var value;
  //       window.MainDatastream.streamAddData(
  //         sqlQuery,
  //         value,
  //         (status, data) => {}
  //       );
  //       SnackboxAlert("snackbar");
  //     }

  //     destroy() {
  //       this.eGui.removeEventListener("click", this.btnClickedHandler);
  //     }
  //   };
  // }

  var gridOptions4 = {
    // define 3 columns
    columnDefs: [
      {
        headerName: "SLN",
        valueGetter: "node.rowIndex + 1",
        resizable: true,
      },
      { headerName: "bill No.", field: "0", resizable: true },
      { headerName: "Party Name ", field: "1", resizable: true },
      { headerName: "Payment Type", field: "2", resizable: true },

      {
        headerName: "Amount",
        field: "3",
        resizable: true,
        floatingFilter: true,
      },
      // { headerName: "Balance Due", field: "5" },
      // {
      //   headerName: "Date",
      //   field: "4",
      //   // valueFormatter: dateFormatter,
      //   comparator: dateComparator,
      //   filter: "agDateColumnFilter",
      //   floatingFilter: true,
      //   floatingFilterComponentParams: {
      //     suppressFilterButton: true,
      //   },
      //   filterParams: {
      //     debounceMs: 500,
      //     suppressAndOrCondition: true,
      //     comparator: function (filterLocalDateAtMidnight, cellValue) {
      //       if (cellValue == null) {
      //         return 0;
      //       }
      //       var dateParts = cellValue.split("-");
      //       var year = Number(dateParts[2]);
      //       var month = Number(dateParts[1]) - 1;
      //       var day = Number(dateParts[0]);
      //       var cellDate = new Date(year, month, day);

      //       if (cellDate < filterLocalDateAtMidnight) {
      //         return -1;
      //       } else if (cellDate > filterLocalDateAtMidnight) {
      //         return 1;
      //       } else {
      //         return 0;
      //       }
      //     },
      //   },
      // },
      // {
      //   headerName: "Action",
      //   field: "4",
      //   resizable: true,
      //   cellRenderer: BtnCellRenderer,
      //   floatingFilter: true,
      //   floatingFilterComponentParams: {
      //     suppressFilterButton: true,
      //   },

      //   cellRendererParams: {
      //     clicked: function (field) {},
      //   },
      // },
    ],
    // getSelectedRows: "getSelectedRows",
    // oncellClicked: "onCellClicked",
    // onSelectionChanged: "onSelectionChanged",
    rowSelection: "multiple",
    // suppressRowClickSelection: true,
    onRowSelected: onRowSelected,
    onRowDoubleClicked: btnClickedHandleEditing,
    onFirstDataRendered: onFirstDataRendered,
    defaultColDef: {
      sortable: true,
      flex: 1,
      // floatingFilter: true,
    },
    pagination: true,
    paginationPageSize: 10,
    animateRows: true,

    // other grid options ...
  };
  // function onFirstDataRendered(params) {
  //   params.api.sizeColumnsToFit();
  // }

  var GridDiv3 = document.getElementById("wrapper1");
  var n = new agGrid.Grid(GridDiv3, gridOptions4);

  window.MainDatastream.streamGetData(
    "SELECT purchase_bill.bill_id,vendor.vendor_name,purchase_bill.bill_pay_method,purchase_bill.total_amnt FROM purchase_bill left join vendor on vendor.PersonID = purchase_bill.vendor_f_id WHERE purchase_bill.is_deleted = '0' ;",
    (status, data) => {
      this.purchasebilldata = JSON.parse(data).data;
      gridOptions4.api.setRowData(JSON.parse(data).data);
    }
  );
  window.electronAPI.setTitle("PURCHASE BILL");

  function onFilterTextBoxChanged() {
    gridOptions4.api.setQuickFilter(
      document.getElementById("filter-text-box").value
    );
  }

  var inp = document.createElement("input");
  var root = document.getElementsByClassName("ag-header-row-column-filter");
  inp.id = "filter-text-box";
  inp.type = "text";
  inp.placeholder = "Type a keyword..";
  inp.oninput = function () {
    onFilterTextBoxChanged();
  };
  root[0].appendChild(inp);

  function download() {
    console.log("this.labourdata with amount", this.purchasebilldata);

    var header = [["bill No.", "Party Name ", "Payment Type", "Amount"]];
    window.ExcelDatastream.Exceldata(
      this.purchasebilldata,
      header,
      (data, header) => {}
    );
  }
  function onRowSelected() {
    const selectedRows = gridOptions4.api.getSelectedRows();
    if (selectedRows) {
      console.log(" row selected");
      document.getElementById("delete_button").style.display = "flex";
      document.getElementById("export_button").style.display = "flex";
      document.getElementById("print_button").style.display = "flex";
      document.getElementById("edit_button").style.display = "flex";
      document.getElementById("convert_button").style.display = "flex";
      if (selectedRows.length > 1) {
        console.log("more than one row selected function called");
        document.getElementById("import_button").style.display = "none";
        document.getElementById("print_button").style.display = "none";
        document.getElementById("edit_button").style.display = "none";
        document.getElementById("convert_button").style.display = "none";
      }
    }
  }
  // import_button = document.getElementById("import_button");
  // import_button.addEventListener("click", async () => {
  //   const filepath = await window.ExcelDatastream.ExcelImportClick();
  //   console.log("filepath", filepath);
  // });
</script>
