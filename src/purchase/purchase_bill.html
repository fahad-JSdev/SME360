<script src="../../node_modules/jquery/dist/jquery.min.js"></script>

<script src="../widgets/autoSearchText.js"></script>
<link rel="stylesheet" href="../assets/themes/autoSearchText.css" />
<link rel="stylesheet" href="../assets/themes/purchase_order.css" />
<script src="../accounts/Product.js"></script>
<script src="../accounts/Receipt.js"></script>
<title>PURCHASE BILL</title>
<body>
  <form id="main-form">
    <div class="client">
      <table class="top-table">
        <div class="container1">
          <div class="material-textfield">
            <input type="text" id="partydt" placeholder="Party" />
          </div>
        </div>
        <tr>
          <td id="pbdtecolumn">
            <label for="pbdate"> bill Date &emsp;</label>
            <input type="date" id="pbdate" name="pbdate" />
          </td>
          <td id="podtecolumn">
            <label for="issue-dt"> Order Date &emsp;</label>
            <input type="date" id="issue-dt" name="issue-dt" />
          </td>

          <td>
            <label for="due-dt">Due Date &emsp;</label>
            <input type="date" id="due-dt" name="due-dt" contenteditable />
          </td>
          <td id="poNumber">
            <label for="pon">P.O. Number</label>
            <input type="text" id="pon" name="pon" disabled contenteditable />
          </td>
          <td id="pbNumber">
            <label for="pBnumber">P.B. Number</label>
            <input
              type="text"
              id="pBnumber"
              name="pon"
              disabled
              contenteditable
            />
          </td>
        </tr>
      </table>
    </div>
    <div class="button-div">
      <button id="Add_item_button" type="button" onclick="">Add Item</button>
      <button id="Add_prty_button" type="button" onclick="">Add Party</button>
      <button
        type="button"
        class="add"
        onclick="addRowIfnotLastcolumnnotempty('myTable')"
      >
        <img src="../assets/images/addrow.png" />
      </button>
      <button type="button" id="delete-row" onclick="deleteRow()">
        <img src="../assets/images/reject2.png" />
      </button>
      <img
        src="../assets/images/print3.png"
        alt="print button"
        id="print_button"
        class="print_button"
        title="print"
        onclick=""
      />
      <img
        src="../assets/images/trash.png"
        alt="delete button"
        id="delete_button"
        class="edit_button"
        title="delete"
        onclick="deleteFunction()"
      />
      <img
        src="../assets/images/approved.png"
        alt="approve button"
        id="approve_button"
        class="approve_button"
        title="approve"
        onclick="approveFunction()"
      />
      <img
        src="../assets/images/color_edit.png"
        alt="edit button"
        id="edit_button"
        class="edit_button"
        title="Edit"
        onclick="editing()"
      />
    </div>
    <div class="min_height">
      <table class="inventory" id="myTable">
        <thead>
          <tr>
            <th class="bold2" rowspan="2">
              <span class="no" id="no">#</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="item" id="item">ITEM</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="batch-no" id="batch-no">BATCH NO.</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="exp-date" id="exp-date">EXPIRY DATE</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="quantity" id="quantity">QUANTITY</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="unit" id="unit">UNIT</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="price/unit" id="price/unit">PRICE/UNIT</span>
            </th>
            <th class="bold" colspan="2">
              <span class="discount" id="discount">DISCOUNT</span>
            </th>
            <th class="bold" colspan="2">
              <span class="tax" id="tax">TAX</span>
            </th>
            <th class="bold" rowspan="2">
              <span class="amount" id="amount">AMOUNT</span>
            </th>
          </tr>

          <tr>
            <th class="bold header">
              <span class="percentage" id="percentage">%</span>
            </th>
            <th class="bold header">
              <span class="disc-amount" id="disc-amount">AMOUNT</span>
            </th>
            <th class="bold header">
              <span class="percentage2" id="percentage2">%</span>
            </th>
            <th class="bold header">
              <span class="disc-amount2" id="disc-amount2">AMOUNT</span>
            </th>
          </tr>
        </thead>

        <tbody id="tbdy"></tbody>
      </table>
    </div>
    <!-- <div class="addrow">
      <a
        class="add noprint"
        title="Add Item"
        onclick="addRowIfnotLastcolumnnotempty('myTable')"
        >Add row</a
      >
    </div> -->
    <div class="right_tax">
      <div class="payment-method">
        <select name="cars" id="payment-select" placeholder=" " type="text">
          <option selected disabled hidden>Payment Method</option>
          <option value="upi">UPI</option>
          <option value="cash">Cash</option>
          <option value="bank">Bank</option>
        </select>
        <input id="file-input" type="file" />
      </div>
      <div class="description-down">
        <textarea placeholder="Description" id="desp"></textarea>
      </div>
      <table class="balance" id="balance">
        <tbody>
          <tr>
            <th class="bold1">
              <span class="total" id="disc">Discount</span>
            </th>
            <td class="disc_td">
              <input type="number" id="granddisc" oninput="getDiscount()" />
            </td>
            <th class="bold1">
              <span class="total" id="total">Total</span>
            </th>
            <td><span>&#8377; </span><span id="grandtotal"></span></td>
          </tr>
        </tbody>
      </table>
    </div>
    <button
      type="button"
      id="save-submit-button"
      onclick="purchaseOrderUpdate()"
    >
      SAVE
    </button>
  </form>
</body>

<script>
  var edit_button = document.getElementById("edit_button");
  var delete_button = document.getElementById("delete_button");
  var aprove_button = document.getElementById("approve_button");
  var print_button = document.getElementById("approve_button");
  edit_button.style.display = "none";
  delete_button.style.display = "none";
  aprove_button.style.display = "none";
  print_button.style.display = "none";

  //event listerner for add_item button
  document.getElementById("Add_item_button").addEventListener("click", () => {
    window.opener.addStock();
  });
  document.getElementById("Add_prty_button").addEventListener("click", () => {
    window.opener.addVendor();
  });
  //vendor name dropdown and contextbridge
  window.MainDatastream.streampurchasepartyview((status, data) => {
    var vendor_name = JSON.parse(data).data;
    console.log("vendor data", JSON.parse(data).data);
    var list = document.getElementById("partydt");
    inflateAutoCompleateView(list, vendor_name);
  });
  var a = document.getElementById("myTable");
  var mReceipt = new Receipt();
  const urlParams = new URLSearchParams(window.location.search);
  const dataString = urlParams.get("data");
  var clickdata_id = JSON.parse(decodeURIComponent(dataString));
  console.log("data from purchase orderhome=>", clickdata_id, clickdata_id[0]);

  if (clickdata_id[1] == "edit" || "editing") {
    console.log("editttttttttttttttttttttt");
    document.getElementById("pbNumber").style.display = "none";
    document.getElementById("poNumber").style.display = "table-cell";
    document.getElementById("podtecolumn").style.display = "table-cell";
    document.getElementById("pbdtecolumn").style.display = "none";
  }
  if (clickdata_id[1] == "convert") {
    console.log("convertttttttttttttttttttttt");
    document.getElementById("pbNumber").style.display = "table-cell";
    document.getElementById("poNumber").style.display = "table-cell";
    document.getElementById("podtecolumn").style.display = "table-cell";
    document.getElementById("pbdtecolumn").style.display = "table-cell";
  }
  if (clickdata_id[0] == "bill") {
    console.log("billlllllllllllllllllllllllllll");
    document.getElementById("poNumber").style.display = "none";
    document.getElementById("pbNumber").style.display = "table-cell";
    document.getElementById("podtecolumn").style.display = "none";
    document.getElementById("pbdtecolumn").style.display = "table-cell";
  }
  if (clickdata_id[1] == "editing") {
    console.log("billlllllllllllllllllllllllllll");
    edit_button.style.display = "block";
    delete_button.style.display = "block";
    aprove_button.style.display = "block";
    print_button.style.display = "block";
    document.getElementById("save-submit-button").style.display = "none";
  }
  var pon = document.getElementById("pon");
  var issue = document.getElementById("issue-dt");
  var due = document.getElementById("due-dt");
  var payment = document.getElementById("payment-select");
  var partydt = document.getElementById("partydt");
  var desp = document.getElementById("desp");
  var disc = document.getElementById("granddisc");
  var gTotal = document.getElementById("grandtotal");

  if (
    clickdata_id[1] == "edit" ||
    clickdata_id[1] == "convert" ||
    clickdata_id[1] == "editing"
  ) {
    window.MainDatastream.streamGetDataOnce(
      "SELECT purchase_order.order_id,purchase_order.po_date,purchase_order.due_date,purchase_order.total_amount,purchase_order.status,purchase_order.unitprice,purchase_order.discount,purchase_order.payment_method,purchase_order.description,pur_or_list.stock_name,pur_or_list.batch_no,pur_or_list.expiry_date,pur_or_list.quantity,pur_or_list.unit,pur_or_list.price_unit,pur_or_list.tax,pur_or_list.amount,vendor.vendor_name,pur_or_list.disc_ount,stock.item_description,stock.stock_id,purchase_order.vendor_f_id,pur_or_list.list_id FROM purchase_order LEFT JOIN vendor ON purchase_order.vendor_f_id = vendor.personid LEFT JOIN purchase_order_list AS pur_or_list ON purchase_order.order_id = pur_or_list.pur_order_f_key LEFT JOIN stock ON pur_or_list.stock_f_key = stock.stock_id WHERE purchase_order.order_id=" +
        clickdata_id[0] +
        "AND pur_or_list.is_deleted='0'" +
        ";",
      (status, data) => {
        this.rowLength = JSON.parse(data).data.length;

        console.log("data for purchase bill table=>", JSON.parse(data).data);

        pon.value = JSON.parse(data).data[0][0];
        issue.value = JSON.parse(data).data[0][1];
        due.value = JSON.parse(data).data[0][2];
        payment.value = JSON.parse(data).data[0][7];
        partydt.value = JSON.parse(data).data[0][17];
        console.log("payment value=>", JSON.parse(data).data[0][7]);
        console.log("description value=>", JSON.parse(data).data[0][8]);
        console.log("discount value=>", JSON.parse(data).data[0][6]);
        desp.value = JSON.parse(data).data[0][8];
        disc.value = JSON.parse(data).data[0][6];
        gTotal.innerHTML = JSON.parse(data).data[0][3];
        partydt.selectedItemId = JSON.parse(data).data[0][21];
        pon.disabled = true;
        issue.disabled = true;
        due.disabled = true;

        partydt.disabled = true;
        if (clickdata_id[1] == "editing") {
          payment.disabled = true;
          gTotal.disabled = true;
          disc.disabled = true;
          desp.disabled = true;
        }

        for (var i = 0; i < JSON.parse(data).data.length; i++) {
          CreateRow("myTable");

          console.log("data types=>", typeof JSON.parse(data).data[i][16]);

          console.log("table data=>", JSON.parse(data).data[i]);
          a.rows[i + 2].cells[1].firstChild.value = JSON.parse(data).data[i][9];
          a.rows[i + 2].cells[1].firstChild.stockId =
            JSON.parse(data).data[i][22];
          a.rows[i + 2].cells[2].firstChild.value =
            JSON.parse(data).data[i][10];
          a.rows[i + 2].cells[3].firstChild.value =
            JSON.parse(data).data[i][11];
          a.rows[i + 2].cells[4].firstChild.value =
            JSON.parse(data).data[i][12];
          a.rows[i + 2].cells[5].firstChild.value =
            JSON.parse(data).data[i][13];
          a.rows[i + 2].cells[6].firstChild.value =
            JSON.parse(data).data[i][14];
          a.rows[i + 2].cells[7].firstChild.value =
            JSON.parse(data).data[i][18];
          a.rows[i + 2].cells[9].firstChild.value =
            JSON.parse(data).data[i][15];
          a.rows[i + 2].cells[11].firstChild.value =
            JSON.parse(data).data[i][16];
          console.log("total value=>", JSON.parse(data).data[i][16]);

          var p = new Product(
            //stock_id //list_id
            [JSON.parse(data).data[i][20], JSON.parse(data).data[i][22]], // id
            JSON.parse(data).data[i][9], //name
            JSON.parse(data).data[i][13], //unit
            parseFloat(JSON.parse(data).data[i][14]), //price
            parseFloat(JSON.parse(data).data[i][18]), //discount
            parseFloat(JSON.parse(data).data[i][15]), //tax
            JSON.parse(data).data[i][19], //details
            JSON.parse(data).data[i][10], //batch_no
            JSON.parse(data).data[i][11] //expiry_dat
          );
          mReceipt.addproduct(p);
          mReceipt
            .getProducts()
            [i].setQuantity(parseFloat(JSON.parse(data).data[i][12]));
          a.rows[i + 2].cells[8].firstChild.value = mReceipt
            .getProducts()
            [i].getDiscountamount();
          a.rows[i + 2].cells[10].firstChild.value = mReceipt
            .getProducts()
            [i].getTaxAmount();
          if (clickdata_id[1] == "edit") {
            a.rows[i + 2].cells[1].firstChild.disabled = true;
            a.rows[i + 2].cells[2].firstChild.disabled = false;
            a.rows[i + 2].cells[3].firstChild.disabled = false;
            a.rows[i + 2].cells[4].firstChild.disabled = false;
            a.rows[i + 2].cells[5].firstChild.disabled = false;
            a.rows[i + 2].cells[6].firstChild.disabled = false;
            a.rows[i + 2].cells[7].firstChild.disabled = false;
            a.rows[i + 2].cells[8].firstChild.disabled = false;
            a.rows[i + 2].cells[9].firstChild.disabled = false;
          }
          if (clickdata_id[1] == "editing") {
            a.rows[i + 2].cells[1].firstChild.disabled = true;
            a.rows[i + 2].cells[2].firstChild.disabled = true;
            a.rows[i + 2].cells[3].firstChild.disabled = true;
            a.rows[i + 2].cells[4].firstChild.disabled = true;
            a.rows[i + 2].cells[5].firstChild.disabled = true;
            a.rows[i + 2].cells[6].firstChild.disabled = true;
            a.rows[i + 2].cells[7].firstChild.disabled = true;
            a.rows[i + 2].cells[8].firstChild.disabled = true;
            a.rows[i + 2].cells[9].firstChild.disabled = true;
          }
        }
      }
    );
  }
  function editing() {
    for (var i = 0; i < a.rows.length - 2; i++) {
      a.rows[i + 2].cells[1].firstChild.disabled = true;
      a.rows[i + 2].cells[2].firstChild.disabled = false;
      a.rows[i + 2].cells[3].firstChild.disabled = false;
      a.rows[i + 2].cells[4].firstChild.disabled = false;
      a.rows[i + 2].cells[5].firstChild.disabled = false;
      a.rows[i + 2].cells[6].firstChild.disabled = false;
      a.rows[i + 2].cells[7].firstChild.disabled = false;
      a.rows[i + 2].cells[8].firstChild.disabled = false;
      a.rows[i + 2].cells[9].firstChild.disabled = false;
      payment.disabled = false;
      gTotal.disabled = false;
      disc.disabled = false;
      desp.disabled = false;
      document.getElementById("save-submit-button").innerText = "Edit";
      document.getElementById("save-submit-button").style.display = "block";
      edit_button.style.display = "none";
      delete_button.style.display = "none";
      aprove_button.style.display = "none";
    }
  }
  function approveFunction() {
    clickdata_id[1] = "convert";
    purchaseOrderUpdate();
  }
  function deleteFunction() {
    var sqlQuery =
      "UPDATE purchase_order SET is_deleted='1' WHERE purchase_order.order_id=" +
      clickdata_id[0] +
      ";";
    var value;
    console.log("deleted value queries=>", sqlQuery);
    window.MainDatastream.streamAddData(sqlQuery, value, (status, data) => {});
    window.close();
  }
  //context bridge to select values from stock & stock_collection
  window.MainDatastream.streamAddBill(
    "SELECT stock.stock_id,stock_collection.product,stock.sales_price,stock.discount,stock.bach_no,stock.expiry,stock.unit,stock.item_description,stock_collection.tax_per,stock.stock_f_id,stock.current_stock FROM stock_collection LEFT JOIN stock ON stock_collection.product_id = stock.stock_f_id ;",
    (status, data) => {
      this.searchVal = JSON.parse(data).data;
      if (clickdata_id[0] == "bill") {
        addRowIfnotLastcolumnnotempty("myTable");
      }
      console.log("serachval=>", this.searchVal);
    }
  );

  document
    .getElementsByTagName("body")[0]
    .addEventListener("keypress", (event) => {
      if (event.key === "Enter") {
        console.log("keypress called");
        addRowIfnotLastcolumnnotempty("myTable");
        event.preventDefault();
      }
    });
  //creating receipt object

  //when page is loaded one row is added
  function addRowIfnotLastcolumnnotempty(table_id) {
    var table = document.getElementById(table_id);
    console.log(
      "addRowIfnotLastcolumnnotempty ==> table row length vs reciept row length",
      table.rows.length - 2,
      mReceipt.getProducts().length
    );
    if (table.rows.length - 2 == mReceipt.getProducts().length) {
      CreateRow(table_id);
    }
  }
  //delete row function

  var sale_tbody = document.getElementById("tbdy");
  var numberofselectedrows = 0;
  var deleteIndex = [];
  var deletedRowId = [];
  function deleteRow() {
    numberofselectedrows = 0;
    document.getElementById("delete-row").style.display = "none";
    for (var i = 2; i < a.rows.length; i++) {
      if (a.rows[i].cells[0].firstChild.checked) {
        deleteIndex.push(i);
        console.log("delete row index=>", i);

        if (
          (i < this.rowLength + 2 && clickdata_id[1] == "convert") ||
          "edit"
        ) {
          deletedRowId.push(a.rows[i].cells[1].firstChild.stockId);
          this.rowLength--;
          console.log("rowlength value", this.rowLength);
        }
      }
    }
    for (var i = deleteIndex.length - 1; i > -1; i--) {
      a.rows[deleteIndex[i]].remove();
      mReceipt.deleteProduct(deleteIndex[i] - 2);
    }

    deleteIndex = [];
    gTotal.innerHTML = mReceipt.getGrandTotal();
    console.log("deleted values id=>", deletedRowId);
  }
  //function to create row

  function CreateRow(table_id) {
    var table = document.getElementById(table_id);
    var t_body = document.getElementById("tbdy");
    var row = t_body.insertRow(table.rows.length - 2);

    var cell1 = row.insertCell(0);
    var cell2 = row.insertCell(1);
    var cell3 = row.insertCell(2);
    var cell4 = row.insertCell(3);
    var cell5 = row.insertCell(4);
    var cell6 = row.insertCell(5);
    var cell7 = row.insertCell(6);
    var cell8 = row.insertCell(7);
    var cell9 = row.insertCell(8);
    var cell10 = row.insertCell(9);
    var cell11 = row.insertCell(10);
    var cell12 = row.insertCell(11);

    cell1.append(createInputCheckbox("cell1"));
    cell2.append(createInputtext());
    cell3.append(createInputtext());
    cell4.append(createInputtextDisabled());
    cell5.append(createInputNumber());
    cell6.append(createInputtextDisabled());
    cell7.append(createInputNumber());
    cell8.append(createInputNumber());
    cell9.append(createInputNumber());
    cell10.append(createInputSelect());
    cell11.append(createInputNumber());
    cell12.append(createInputNumber());

    table.oninput = (event) => {
      updateProduct(event);
    };
    console.log("searchval value inside createrow=>", this.searchVal);

    inflateAutoCompleateView(
      table.rows[table.rows.length - 1].cells[1].firstChild,
      this.searchVal,
      table.rows.length,
      (product, rowIndex) => {
        rowIndex = rowIndex - 1;

        console.log("selected product ==> ", product, " ", rowIndex);
        var a = document.getElementById("myTable");
        var gTotal = document.getElementById("grandtotal");
        a.rows[rowIndex].cells[2].firstChild.disabled = false;
        a.rows[rowIndex].cells[3].firstChild.disabled = false;
        a.rows[rowIndex].cells[4].firstChild.disabled = false;
        a.rows[rowIndex].cells[5].firstChild.disabled = false;
        a.rows[rowIndex].cells[6].firstChild.disabled = false;
        a.rows[rowIndex].cells[7].firstChild.disabled = false;
        a.rows[rowIndex].cells[8].firstChild.disabled = false;
        a.rows[rowIndex].cells[9].firstChild.disabled = false;

        console.log("column filled");
        var p = new Product(
          [product[0]],
          product[1],
          product[6],
          product[2],
          product[3],
          product[8],
          product[7],
          product[4],
          product[5]
        );
        mReceipt.addproduct(p);
        selectColumnFill(product, a, rowIndex);
        console.log(
          "total amount when item is added=>",
          mReceipt.getProducts()[rowIndex - 2].getTotal()
        );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        a.rows[rowIndex].cells[4].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getQuantity();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
      }
    );
  }

  function createInputCheckbox(id) {
    var checkType = document.createElement("input");
    checkType.type = "checkbox";
    checkType.id = id;
    checkType.addEventListener("click", (event) => {
      if (event.target.checked) {
        numberofselectedrows++;
      } else {
        numberofselectedrows--;
      }
      if (numberofselectedrows > 0) {
        document.getElementById("delete-row").style.display = "inline-block";
      } else {
        document.getElementById("delete-row").style.display = "none";
      }
    });
    return checkType;
  }

  function createInputtext() {
    var textType = document.createElement("input");
    textType.type = "text";

    return textType;
  }
  function createInputtextDisabled() {
    var textType = document.createElement("input");
    textType.type = "text";
    textType.disabled = true;
    return textType;
  }
  function createInputNumber() {
    var numType = document.createElement("input");
    numType.type = "number";
    numType.min = "0";
    numType.disabled = true;

    return numType;
  }
  // function createImg(table, imgsrc) {
  //   var imgType = document.createElement("img");
  //   imgType.src = imgsrc;
  //   imgType.onclick = (event) => {
  //     console.log(
  //       "deleted the row ==> " + event.target.parentNode.parentNode.rowIndex
  //     );
  //     mReceipt.deleteProduct(event.target.parentNode.parentNode.rowIndex - 2);
  //     table.rows[event.target.parentNode.parentNode.rowIndex].remove();

  //     gTotal.innerHTML = mReceipt.getGrandTotal();
  //   };

  //   return imgType;
  // }
  function createInputSelect() {
    var SelectType = document.createElement("select");
    SelectType.disabled = true;
    var selectarray = [0, 5, 12, 18, 28];

    for (var i = 0; i < 5; i++) {
      var optionApp = document.createElement("option");
      optionApp.value = selectarray[i];
      optionApp.innerHTML = selectarray[i];
      SelectType.appendChild(optionApp);
    }
    return SelectType;
  }

  var gTotal = document.getElementById("grandtotal");
  function updateProduct(event) {
    let cell = event.target;
    var rowIndex = cell.parentNode.parentNode.rowIndex;
    var cellIndex = cell.parentNode.cellIndex;

    switch (cellIndex) {
      case 2:
        mReceipt
          .getProducts()
          [rowIndex - 2].setbatch(a.rows[rowIndex].cells[2].firstChild.value);
        break;
      case 3:
        mReceipt
          .getProducts()
          [rowIndex - 2].setExpiry(a.rows[rowIndex].cells[3].firstChild.value);
        break;
      case 4:
        mReceipt
          .getProducts()
          [rowIndex - 2].setQuantity(
            a.rows[rowIndex].cells[4].firstChild.value
          );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 5:
        mReceipt
          .getProducts()
          [rowIndex - 2].setUnit(a.rows[rowIndex].cells[5].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 6:
        mReceipt
          .getProducts()
          [rowIndex - 2].setPrice(a.rows[rowIndex].cells[6].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
      case 7:
        mReceipt
          .getProducts()
          [rowIndex - 2].setDiscount(
            a.rows[rowIndex].cells[7].firstChild.value
          );

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        console.log("discount amo changed");
        break;
      case 8:
        console.log(
          "discount amount changed",
          (a.rows[rowIndex].cells[8].firstChild.value /
            mReceipt.getProducts()[rowIndex - 2].getTotalPrice()) *
            100
        );
        a.rows[rowIndex].cells[7].firstChild.value =
          Math.round(
            (a.rows[rowIndex].cells[8].firstChild.value /
              mReceipt.getProducts()[rowIndex - 2].getTotalPrice()) *
              100 *
              1e2
          ) / 1e2;

        mReceipt
          .getProducts()
          [rowIndex - 2].setDiscount(
            a.rows[rowIndex].cells[7].firstChild.value
          );
        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();

        break;

      case 9:
        mReceipt
          .getProducts()
          [rowIndex - 2].setTax(a.rows[rowIndex].cells[9].firstChild.value);

        a.rows[rowIndex].cells[11].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTotal();
        gTotal.innerHTML = mReceipt.getGrandTotal();
        a.rows[rowIndex].cells[10].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getTaxAmount();
        a.rows[rowIndex].cells[8].firstChild.value = mReceipt
          .getProducts()
          [rowIndex - 2].getDiscountamount();
        break;
    }
  }

  window.MainDatastream.streamAddBill(
    "SELECT bill_id FROM purchase_bill ORDER BY bill_id DESC LIMIT 1 ;",
    (status, data) => {
      console.log("purchase_bill no", JSON.parse(data).data);
      document.getElementById("pBnumber").value =
        parseInt(JSON.parse(data).data[0]) + 1;
      // var account_id = JSON.parse(data).data;
      // document.getElementById("pon").value =
      //   account_id[account_id.length - 1][0] + 1;
    }
  );

  function selectColumnFill(product, a, rowIndex) {
    //batch_no
    (a.rows[rowIndex].cells[2].firstChild.value = product[4]),
      //expiry_date
      (a.rows[rowIndex].cells[3].firstChild.value = product[5]),
      //unit
      (a.rows[rowIndex].cells[5].firstChild.value = product[6]),
      //price
      (a.rows[rowIndex].cells[6].firstChild.value = product[2]),
      //discount
      (a.rows[rowIndex].cells[7].firstChild.value = product[3]),
      //discount amount
      (a.rows[rowIndex].cells[8].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getDiscountamount()),
      //tax
      (a.rows[rowIndex].cells[9].firstChild.value = product[8]),
      //tax amount
      (a.rows[rowIndex].cells[10].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getTaxAmount()),
      //total amount
      (a.rows[rowIndex].cells[11].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getTotal()),
      //quantity
      (a.rows[rowIndex].cells[4].firstChild.value = mReceipt
        .getProducts()
        [rowIndex - 2].getQuantity()),
      //grandTotal
      (gTotal.innerHTML = mReceipt.getGrandTotal());
  }

  //============================================
  function currentDate(datId) {
    datId.valueAsDate = new Date();
  }
  currentDate(document.getElementById("pbdate"));

  function getDiscount() {
    mReceipt.setDiscount(document.getElementById("granddisc").value);
    gTotal.innerHTML = mReceipt.getGrandTotal();
  }

  document
    .getElementById("save-submit-button")
    .addEventListener("click", console.log("save event called"));

  function purchaseOrderUpdate() {
    var reciept_n = document.getElementById("pon").value;
    var table_data = document.getElementById("myTable");
    var issue_date_po = document.getElementById("issue-dt").value;
    var pb_dat = document.getElementById("pbdate").value;
    var due_date_po = document.getElementById("due-dt").value;
    var pay_method_po = document.getElementById("payment-select").value;
    var party_id = document.getElementById("partydt").selectedItemId;
    console.log("selecteditemid=>", party_id);
    var desp = document.getElementById("desp").value;
    var disc = document.getElementById("granddisc").value;
    var poNum = document.getElementById("pBnumber").value;
    var value;
    mReceipt.setReceipt(reciept_n);
    mReceipt.setDate(issue_date_po);
    if (
      clickdata_id[1] == "edit" ||
      clickdata_id[1] == "convert" ||
      clickdata_id[1] == "editing"
    ) {
      document.getElementById("poNumber").style.display = "block";
      //update purchase_order
      var po_sql_query =
        "UPDATE purchase_order SET payment_method=" +
        "'" +
        pay_method_po +
        "'" +
        "," +
        "discount=" +
        "'" +
        disc +
        "'" +
        "," +
        "description=" +
        "'" +
        desp +
        "'" +
        "," +
        "total_amount=" +
        "'" +
        mReceipt.getGrandTotal() +
        "'" +
        " " +
        "WHERE purchase_order.order_id=" +
        reciept_n +
        ";";
      console.log("streampurchaseorderquery=>", po_sql_query);
      window.MainDatastream.streamAddData(
        po_sql_query,
        value,
        (status, data) => {
          console.log("streampurchaseorder=>", status, JSON.parse(data));
        }
      );

      //update purchase_order_list
      var data_value = mReceipt.getProducts();
      console.log(
        "data_value",
        typeof data_value,
        data_value,
        data_value[0].getId()
      );

      for (var i = 0; i < this.rowLength; i++) {
        console.log("function called ", i, this.rowLength);
        var update_querry =
          "UPDATE purchase_order_list SET price_unit=" +
          "'" +
          data_value[i].getPrice() +
          "'" +
          "," +
          "unit=" +
          "'" +
          data_value[i].getUnit() +
          "'" +
          "," +
          "tax=" +
          "'" +
          data_value[i].getTax() +
          "'" +
          "," +
          "amount=" +
          "'" +
          data_value[i].getTotal() +
          "'" +
          "," +
          "quantity=" +
          "'" +
          data_value[i].getQuantity() +
          "'" +
          "," +
          "expiry_date=" +
          "'" +
          data_value[i].getexpiry() +
          "'" +
          "," +
          "disc_ount=" +
          "'" +
          data_value[i].getDiscount() +
          "'" +
          "," +
          "batch_no=" +
          "'" +
          data_value[i].getbatch_no() +
          "'" +
          " " +
          "WHERE purchase_order_list.list_id=" +
          data_value[i].getId()[1] +
          ";";
        console.log("streampurchaseorderlistquery=>", update_querry);
        window.MainDatastream.streamAddData(
          update_querry,
          value,
          (status, data) => {
            console.log(
              "streampurchaseorderlistdata=>",
              status,
              JSON.parse(data)
            );
          }
        );
      }
      //insert new values in purcahse_order_list
      var purListIns = "";
      for (var i = this.rowLength; i < data_value.length; i++) {
        purListIns +=
          "('" +
          mReceipt.getReceipt() +
          "','" +
          data_value[i].getName() +
          "','" +
          data_value[i].getUnit() +
          "','" +
          data_value[i].getId()[0] +
          "','" +
          data_value[i].getPrice() +
          "','" +
          data_value[i].getQuantity() +
          "','" +
          data_value[i].getDiscount() +
          "','" +
          data_value[i].getTax() +
          "','" +
          data_value[i].getTotal() +
          "','" +
          data_value[i].getexpiry() +
          "','" +
          data_value[i].getbatch_no() +
          "')";
        if (i < data_value.length - 1) {
          purListIns += ",";
        }
      }
      console.log("streaminsertpurchaseordervalue=>", purListIns);

      window.MainDatastream.streamAddData(
        "INSERT INTO purchase_order_list(pur_order_f_key ,stock_name,unit,stock_f_key,price_unit,quantity,disc_ount,tax,amount,expiry_date,batch_no)",
        purListIns,
        (status, data) => {
          console.log("addstock", status, data);
        }
      );

      //update deleted values in purchase_order_list
      if (deletedRowId.length != 0) {
        console.log("deletequery called", deletedRowId.length);
        for (var i = 0; i < deletedRowId.length; i++) {
          var sqlUpdateQuery =
            "UPDATE purchase_order_list SET is_deleted='1' WHERE list_id=" +
            deletedRowId[i] +
            ";";
          console.log("deletequery called", deletedRowId, sqlUpdateQuery);

          window.MainDatastream.streamAddData(
            sqlUpdateQuery,
            value,
            (status, data) => {}
          );
        }
      }
      //=============================================================================================================
    }
    if (clickdata_id[0] == "bill" || clickdata_id[1] == "convert") {
      if (clickdata_id[0] == "bill") {
        reciept_n = null;
      }
      //inserting values in purchase_bill
      var bill_query =
        "INSERT INTO purchase_bill (vendor_f_id,po_dat,due_dat,bill_pay_method,bill_discount,total_amnt,pur_order_f_key,bill_description,pb_dat)";
      var po_data =
        "('" +
        party_id +
        "','" +
        issue_date_po +
        "','" +
        due_date_po +
        "','" +
        pay_method_po +
        "','" +
        disc +
        "','" +
        mReceipt.getGrandTotal() +
        "'," +
        reciept_n +
        ",'" +
        desp +
        "','" +
        pb_dat +
        "')";
      console.log("streampurchasebilladdquery=>", bill_query, po_data);
      window.MainDatastream.streamAddData(
        bill_query,
        po_data,
        (status, data) => {
          console.log("streampurchasebilladdvalue=>", status, JSON.parse(data));
          //inserting values in purchase_bill_list
          purchaseBilllistSubmit(JSON.parse(data)[0][0]);
        }
      );

      //inserting values in stock
      var stockDetails = "";

      console.log("data value=>", data_value.length);
      for (var i = 0; i < data_value.length; i++) {
        for (var j = 0; j < this.searchVal.length; j++) {
          console.log("index data value matrix=>", i, j);
          console.log(
            "searchval in stock update=>",
            this.searchVal[j][0],
            data_value[i].getId() + "    " + i
          );
          if (this.searchVal[j][0] == data_value[i].getId()[0]) {
            console.log("id matched");

            //if batch number is matched updating quantities in stock
            if (this.searchVal[j][4] == data_value[i].getbatch_no()) {
              console.log("batch number matched", i);
              var stock_querry =
                "UPDATE stock SET expiry=" +
                "'" +
                data_value[i].getexpiry() +
                "'" +
                "," +
                "current_stock=" +
                "'" +
                (data_value[i].getQuantity() +
                  parseInt(this.searchVal[j][10])) +
                "'" +
                "," +
                "unit=" +
                "'" +
                data_value[i].getUnit() +
                "'" +
                "," +
                "sales_price=" +
                "'" +
                data_value[i].getPrice() +
                "'" +
                "," +
                "discount=" +
                "'" +
                data_value[i].getDiscount() +
                "'" +
                " " +
                "WHERE stock.stock_id=" +
                data_value[i].getId()[0] +
                ";";
              console.log("streamstocklistquery=>", stock_querry);
              window.MainDatastream.streamAddData(
                stock_querry,
                value,
                (status, data) => {
                  console.log(
                    "streampurchaseorderlistdata=>",
                    status,
                    JSON.parse(data)
                  );
                }
              );
            }
            //if batch number is not matched inserting new stock
            else {
              console.log("else condition called");
              console.log("stockDetails", this.searchVal[j][9]);
              if (stockDetails != "") {
                stockDetails += ",";
              }

              stockDetails +=
                "('" +
                this.searchVal[j][9] +
                "','" +
                data_value[i].getbatch_no() +
                "','" +
                data_value[i].getexpiry() +
                "','" +
                data_value[i].getQuantity() +
                "','" +
                data_value[i].getDiscount() +
                "','" +
                data_value[i].getUnit() +
                "','" +
                data_value[i].getPrice() +
                "')";
            }
          }
        }
      }

      var stockSqlQuery =
        "INSERT INTO stock (stock_f_id,bach_no,expiry,current_stock,discount,unit,sales_price)";
      console.log("batch change", stockDetails, stockSqlQuery);
      window.MainDatastream.streamAddStock(
        stockSqlQuery,
        stockDetails,
        (status, data) => {
          console.log("addstock", status, data);
        }
      );

      //updating purchase_order status converted
      var upQuery =
        "UPDATE purchase_order SET status ='Converted' WHERE purchase_order.order_id=" +
        clickdata_id[0] +
        ";";

      window.MainDatastream.streamAddData(upQuery, value, (status, data) => {});
    }

    function purchaseBilllistSubmit(purId) {
      var data_value = mReceipt.getProducts();
      console.log("data_value", data_value);
      var bill_list_query =
        "INSERT INTO purchase_bill_list(pur_bill_f_key ,list_stockname,stock_f_key,list_price,list_quantity,list_discount,list_tax,list_amount,exp_dat,list_batch,list_unit)";
      console.log();
      var purchaseBillDetails = "";
      for (var i = 0; i < data_value.length; i++) {
        purchaseBillDetails +=
          "('" +
          purId +
          "','" +
          data_value[i].getName() +
          "','" +
          data_value[i].getId()[0] +
          "','" +
          data_value[i].getPrice() +
          "','" +
          data_value[i].getQuantity() +
          "','" +
          data_value[i].getDiscount() +
          "','" +
          data_value[i].getTax() +
          "','" +
          data_value[i].getTotal() +
          "','" +
          data_value[i].getexpiry() +
          "','" +
          data_value[i].getbatch_no() +
          "','" +
          data_value[i].getUnit() +
          "')";
        if (i < data_value.length - 1) {
          purchaseBillDetails += ",";
        }
      }
      console.log(
        "billlistinsertquery=>",
        bill_list_query,
        purchaseBillDetails
      );

      window.MainDatastream.streamAddData(
        bill_list_query,
        purchaseBillDetails,
        (status, data) => {
          console.log("billlistinsertdata", status, data);
        }
      );
      if (clickdata_id[1] == "edit" || clickdata_id[1] == "convert") {
        window.close();
      }
      if (clickdata_id[0] == "bill") {
        location.reload("true");
      }
    }
  }
</script>
